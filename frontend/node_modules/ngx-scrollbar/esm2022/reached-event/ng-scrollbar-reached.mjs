import { isPlatformBrowser } from '@angular/common';
import { Directive, Input, Output, NgZone, Renderer2, Injector, inject, signal, effect, numberAttribute, booleanAttribute, runInInjectionContext, EventEmitter, PLATFORM_ID } from '@angular/core';
import { NG_SCROLLBAR } from 'ngx-scrollbar';
import * as i0 from "@angular/core";
export class NgScrollbarReached {
    constructor() {
        this.isBrowser = isPlatformBrowser(inject(PLATFORM_ID));
        this.zone = inject(NgZone);
        this.renderer = inject(Renderer2);
        this.injector = inject(Injector);
        this.scrollbar = inject(NG_SCROLLBAR);
        this.disabled = signal(false);
        /** An array that contains all trigger elements  **/
        this.triggerElements = [];
        /** An array that contains the chosen outputs */
        this.subscribedEvents = [];
        this.reachedTop = new EventEmitter();
        this.reachedBottom = new EventEmitter();
        this.reachedStart = new EventEmitter();
        this.reachedEnd = new EventEmitter();
        /** A mapper function to ease forwarding the intersected element to its proper output */
        this.reachedEventActions = {
            top: { emit: () => this.scrollbar.isVerticallyScrollable() ? this.reachedTop.emit() : null },
            bottom: { emit: () => this.scrollbar.isVerticallyScrollable() ? this.reachedBottom.emit() : null },
            start: { emit: () => this.scrollbar.isHorizontallyScrollable() ? this.reachedStart.emit() : null },
            end: { emit: () => this.scrollbar.isHorizontallyScrollable() ? this.reachedEnd.emit() : null }
        };
    }
    /** Reached offset value in px */
    set offsetSetter(value) {
        this.setCssVariable('--reached-offset', value);
    }
    set offsetTopSetter(value) {
        this.setCssVariable('--reached-offset-top', value);
    }
    set offsetBottomSetter(value) {
        this.setCssVariable('--reached-offset-bottom', value);
    }
    set offsetStartSetter(value) {
        this.setCssVariable('--reached-offset-start', value);
    }
    set offsetEndSetter(value) {
        this.setCssVariable('--reached-offset-end', value);
    }
    set disableReachedSetter(value) {
        this.disabled.set(value);
    }
    onReached(trigger) {
        if (trigger) {
            this.reachedEventActions[trigger]?.emit();
        }
    }
    activate() {
        this.zone.runOutsideAngular(() => {
            // Create the scrollbars element inside the viewport
            this.triggerElementsWrapper = this.renderer.createElement('div');
            this.renderer.addClass(this.triggerElementsWrapper, 'ng-scroll-reached-wrapper');
            this.renderer.appendChild(this.scrollbar.viewport.contentWrapperElement, this.triggerElementsWrapper);
            // Create a trigger element for each subscribed event
            this.subscribedEvents.forEach((event) => {
                const triggerElement = this.renderer.createElement('div');
                this.renderer.addClass(triggerElement, 'scroll-reached-trigger-element');
                this.renderer.setAttribute(triggerElement, 'trigger', event);
                this.renderer.appendChild(this.triggerElementsWrapper, triggerElement);
                this.triggerElements.push(triggerElement);
            });
            // The first time the observer is triggered as soon as the element is observed,
            // This flag is used to ignore this first trigger
            let intersectionObserverInit = false;
            this.intersectionObserver = new IntersectionObserver((entries) => {
                if (intersectionObserverInit) {
                    entries.forEach((entry) => {
                        if (entry.isIntersecting) {
                            // Forward the detected trigger element only after the observer is initialized
                            // Only observe the trigger elements when scrollable
                            this.zone.run(() => this.onReached(entry.target.getAttribute('trigger')));
                        }
                    });
                }
                else {
                    // Once the initial element is detected set a flag to true
                    intersectionObserverInit = true;
                }
            }, {
                root: this.scrollbar.viewport.nativeElement,
            });
            this.triggerElements.forEach((el) => this.intersectionObserver.observe(el));
        });
    }
    deactivate() {
        this.intersectionObserver?.disconnect();
        this.triggerElementsWrapper?.remove();
        this.triggerElements = [];
    }
    setCssVariable(property, value) {
        if (value) {
            this.scrollbar.nativeElement.style.setProperty(property, `${value}px`);
        }
    }
    ngOnInit() {
        if (this.reachedTop.observed) {
            this.subscribedEvents.push('top');
        }
        if (this.reachedBottom.observed) {
            this.subscribedEvents.push('bottom');
        }
        if (this.reachedStart.observed) {
            this.subscribedEvents.push('start');
        }
        if (this.reachedBottom.observed) {
            this.subscribedEvents.push('end');
        }
        runInInjectionContext(this.injector, () => {
            effect(() => {
                if (this.disabled()) {
                    this.deactivate();
                }
                else {
                    if (this.isBrowser) {
                        this.activate();
                    }
                }
            });
        });
    }
    ngOnDestroy() {
        this.deactivate();
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.2.1", ngImport: i0, type: NgScrollbarReached, deps: [], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "16.1.0", version: "17.2.1", type: NgScrollbarReached, isStandalone: true, selector: "ng-scrollbar[reachedTop], ng-scrollbar[reachedBottom], ng-scrollbar[reachedStart], ng-scrollbar[reachedEnd]", inputs: { offsetSetter: ["reachedOffset", "offsetSetter", numberAttribute], offsetTopSetter: ["reachedTopOffset", "offsetTopSetter", numberAttribute], offsetBottomSetter: ["reachedBottomOffset", "offsetBottomSetter", numberAttribute], offsetStartSetter: ["reachedStartOffset", "offsetStartSetter", numberAttribute], offsetEndSetter: ["reachedEndOffset", "offsetEndSetter", numberAttribute], disableReachedSetter: ["disableReached", "disableReachedSetter", booleanAttribute] }, outputs: { reachedTop: "reachedTop", reachedBottom: "reachedBottom", reachedStart: "reachedStart", reachedEnd: "reachedEnd" }, ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.2.1", ngImport: i0, type: NgScrollbarReached, decorators: [{
            type: Directive,
            args: [{
                    selector: 'ng-scrollbar[reachedTop], ng-scrollbar[reachedBottom], ng-scrollbar[reachedStart], ng-scrollbar[reachedEnd]',
                    standalone: true,
                }]
        }], propDecorators: { offsetSetter: [{
                type: Input,
                args: [{ alias: 'reachedOffset', transform: numberAttribute }]
            }], offsetTopSetter: [{
                type: Input,
                args: [{ alias: 'reachedTopOffset', transform: numberAttribute }]
            }], offsetBottomSetter: [{
                type: Input,
                args: [{ alias: 'reachedBottomOffset', transform: numberAttribute }]
            }], offsetStartSetter: [{
                type: Input,
                args: [{ alias: 'reachedStartOffset', transform: numberAttribute }]
            }], offsetEndSetter: [{
                type: Input,
                args: [{ alias: 'reachedEndOffset', transform: numberAttribute }]
            }], disableReachedSetter: [{
                type: Input,
                args: [{ alias: 'disableReached', transform: booleanAttribute }]
            }], reachedTop: [{
                type: Output
            }], reachedBottom: [{
                type: Output
            }], reachedStart: [{
                type: Output
            }], reachedEnd: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctc2Nyb2xsYmFyLXJlYWNoZWQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtc2Nyb2xsYmFyL3JlYWNoZWQtZXZlbnQvc3JjL25nLXNjcm9sbGJhci1yZWFjaGVkLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3BELE9BQU8sRUFDTCxTQUFTLEVBQ1QsS0FBSyxFQUNMLE1BQU0sRUFHTixNQUFNLEVBQ04sU0FBUyxFQUVULFFBQVEsRUFDUixNQUFNLEVBQ04sTUFBTSxFQUNOLE1BQU0sRUFDTixlQUFlLEVBQ2YsZ0JBQWdCLEVBQ2hCLHFCQUFxQixFQUNyQixZQUFZLEVBQ1osV0FBVyxFQUNaLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBZ0IsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDOztBQVUzRCxNQUFNLE9BQU8sa0JBQWtCO0lBSi9CO1FBTW1CLGNBQVMsR0FBWSxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztRQUU1RCxTQUFJLEdBQVcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRTlCLGFBQVEsR0FBYyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFeEMsYUFBUSxHQUFhLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUV0QyxjQUFTLEdBQWlCLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUUvQyxhQUFRLEdBQTRCLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVuRSxvREFBb0Q7UUFDNUMsb0JBQWUsR0FBa0IsRUFBRSxDQUFDO1FBSzVDLGdEQUFnRDtRQUN4QyxxQkFBZ0IsR0FBYSxFQUFFLENBQUM7UUErQjlCLGVBQVUsR0FBdUIsSUFBSSxZQUFZLEVBQVEsQ0FBQztRQUMxRCxrQkFBYSxHQUF1QixJQUFJLFlBQVksRUFBUSxDQUFDO1FBQzdELGlC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QUFnQixFQUFFO2dCQUtyRCxVQUFVO3NCQUFuQixNQUFNO2dCQUNHLGFBQWE7c0JBQXRCLE1BQU07Z0JBQ0csWUFBWTtzQkFBckIsTUFBTTtnQkFDRyxVQUFVO3NCQUFuQixNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xyXG5pbXBvcnQge1xyXG4gIERpcmVjdGl2ZSxcclxuICBJbnB1dCxcclxuICBPdXRwdXQsXHJcbiAgT25Jbml0LFxyXG4gIE9uRGVzdHJveSxcclxuICBOZ1pvbmUsXHJcbiAgUmVuZGVyZXIyLFxyXG4gIFdyaXRhYmxlU2lnbmFsLFxyXG4gIEluamVjdG9yLFxyXG4gIGluamVjdCxcclxuICBzaWduYWwsXHJcbiAgZWZmZWN0LFxyXG4gIG51bWJlckF0dHJpYnV0ZSxcclxuICBib29sZWFuQXR0cmlidXRlLFxyXG4gIHJ1bkluSW5qZWN0aW9uQ29udGV4dCxcclxuICBFdmVudEVtaXR0ZXIsXHJcbiAgUExBVEZPUk1fSURcclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgX05nU2Nyb2xsYmFyLCBOR19TQ1JPTExCQVIgfSBmcm9tICduZ3gtc2Nyb2xsYmFyJztcclxuXHJcbnR5cGUgUmVhY2hlZEV2ZW50QWN0aW9uID0ge1xyXG4gIGVtaXQ6ICgpID0+IHZvaWQ7XHJcbn1cclxuXHJcbkBEaXJlY3RpdmUoe1xyXG4gIHNlbGVjdG9yOiAnbmctc2Nyb2xsYmFyW3JlYWNoZWRUb3BdLCBuZy1zY3JvbGxiYXJbcmVhY2hlZEJvdHRvbV0sIG5nLXNjcm9sbGJhcltyZWFjaGVkU3RhcnRdLCBuZy1zY3JvbGxiYXJbcmVhY2hlZEVuZF0nLFxyXG4gIHN0YW5kYWxvbmU6IHRydWUsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBOZ1Njcm9sbGJhclJlYWNoZWQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgaXNCcm93c2VyOiBib29sZWFuID0gaXNQbGF0Zm9ybUJyb3dzZXIoaW5qZWN0KFBMQVRGT1JNX0lEKSk7XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgem9uZTogTmdab25lID0gaW5qZWN0KE5nWm9uZSk7XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgcmVuZGVyZXI6IFJlbmRlcmVyMiA9IGluamVjdChSZW5kZXJlcjIpO1xyXG5cclxuICBwcml2YXRlIHJlYWRvbmx5IGluamVjdG9yOiBJbmplY3RvciA9IGluamVjdChJbmplY3Rvcik7XHJcblxyXG4gIHByaXZhdGUgcmVhZG9ubHkgc2Nyb2xsYmFyOiBfTmdTY3JvbGxiYXIgPSBpbmplY3QoTkdfU0NST0xMQkFSKTtcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSBkaXNhYmxlZDogV3JpdGFibGVTaWduYWw8Ym9vbGVhbj4gPSBzaWduYWwoZmFsc2UpO1xyXG5cclxuICAvKiogQW4gYXJyYXkgdGhhdCBjb250YWlucyBhbGwgdHJpZ2dlciBlbGVtZW50cyAgKiovXHJcbiAgcHJpdmF0ZSB0cmlnZ2VyRWxlbWVudHM6IEhUTUxFbGVtZW50W10gPSBbXTtcclxuXHJcbiAgLyoqIFRoZSBpbnRlcnNlY3Rpb24gb2JzZXJ2ZXIgcmVmZXJlbmNlICovXHJcbiAgcHJpdmF0ZSBpbnRlcnNlY3Rpb25PYnNlcnZlcjogSW50ZXJzZWN0aW9uT2JzZXJ2ZXI7XHJcblxyXG4gIC8qKiBBbiBhcnJheSB0aGF0IGNvbnRhaW5zIHRoZSBjaG9zZW4gb3V0cHV0cyAqL1xyXG4gIHByaXZhdGUgc3Vic2NyaWJlZEV2ZW50czogc3RyaW5nW10gPSBbXTtcclxuXHJcbiAgLyoqIFRoZSBzY3JvbGxiYXJzIGVsZW1lbnQgdGhhdCBjb250YWlucyB0aGUgdHJpZ2dlciBlbGVtZW50cyAqL1xyXG4gIHByaXZhdGUgdHJpZ2dlckVsZW1lbnRzV3JhcHBlcjogSFRNTEVsZW1lbnQ7XHJcblxyXG4gIC8qKiBSZWFjaGVkIG9mZnNldCB2YWx1ZSBpbiBweCAqL1xyXG4gIEBJbnB1dCh7IGFsaWFzOiAncmVhY2hlZE9mZnNldCcsIHRyYW5zZm9ybTogbnVtYmVyQXR0cmlidXRlIH0pIHNldCBvZmZzZXRTZXR0ZXIodmFsdWU6IG51bWJlcikge1xyXG4gICAgdGhpcy5zZXRDc3NWYXJpYWJsZSgnLS1yZWFjaGVkLW9mZnNldCcsIHZhbHVlKTtcclxuICB9XHJcblxyXG4gIEBJbnB1dCh7IGFsaWFzOiAncmVhY2hlZFRvcE9mZnNldCcsIHRyYW5zZm9ybTogbnVtYmVyQXR0cmlidXRlIH0pIHNldCBvZmZzZXRUb3BTZXR0ZXIodmFsdWU6IG51bWJlcikge1xyXG4gICAgdGhpcy5zZXRDc3NWYXJpYWJsZSgnLS1yZWFjaGVkLW9mZnNldC10b3AnLCB2YWx1ZSk7XHJcbiAgfVxyXG5cclxuICBASW5wdXQoeyBhbGlhczogJ3JlYWNoZWRCb3R0b21PZmZzZXQnLCB0cmFuc2Zvcm06IG51bWJlckF0dHJpYnV0ZSB9KSBzZXQgb2Zmc2V0Qm90dG9tU2V0dGVyKHZhbHVlOiBudW1iZXIpIHtcclxuICAgIHRoaXMuc2V0Q3NzVmFyaWFibGUoJy0tcmVhY2hlZC1vZmZzZXQtYm90dG9tJywgdmFsdWUpO1xyXG4gIH1cclxuXHJcbiAgQElucHV0KHsgYWxpYXM6ICdyZWFjaGVkU3RhcnRPZmZzZXQnLCB0cmFuc2Zvcm06IG51bWJlckF0dHJpYnV0ZSB9KSBzZXQgb2Zmc2V0U3RhcnRTZXR0ZXIodmFsdWU6IG51bWJlcikge1xyXG4gICAgdGhpcy5zZXRDc3NWYXJpYWJsZSgnLS1yZWFjaGVkLW9mZnNldC1zdGFydCcsIHZhbHVlKTtcclxuICB9XHJcblxyXG4gIEBJbnB1dCh7IGFsaWFzOiAncmVhY2hlZEVuZE9mZnNldCcsIHRyYW5zZm9ybTogbnVtYmVyQXR0cmlidXRlIH0pIHNldCBvZmZzZXRFbmRTZXR0ZXIodmFsdWU6IG51bWJlcikge1xyXG4gICAgdGhpcy5zZXRDc3NWYXJpYWJsZSgnLS1yZWFjaGVkLW9mZnNldC1lbmQnLCB2YWx1ZSk7XHJcbiAgfVxyXG5cclxuICBASW5wdXQoeyBhbGlhczogJ2Rpc2FibGVSZWFjaGVkJywgdHJhbnNmb3JtOiBib29sZWFuQXR0cmlidXRlIH0pXHJcbiAgc2V0IGRpc2FibGVSZWFjaGVkU2V0dGVyKHZhbHVlOiBib29sZWFuKSB7XHJcbiAgICB0aGlzLmRpc2FibGVkLnNldCh2YWx1ZSk7XHJcbiAgfVxyXG5cclxuICBAT3V0cHV0KCkgcmVhY2hlZFRvcDogRXZlbnRFbWl0dGVyPHZvaWQ+ID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xyXG4gIEBPdXRwdXQoKSByZWFjaGVkQm90dG9tOiBFdmVudEVtaXR0ZXI8dm9pZD4gPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XHJcbiAgQE91dHB1dCgpIHJlYWNoZWRTdGFydDogRXZlbnRFbWl0dGVyPHZvaWQ+ID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xyXG4gIEBPdXRwdXQoKSByZWFjaGVkRW5kOiBFdmVudEVtaXR0ZXI8dm9pZD4gPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XHJcblxyXG4gIC8qKiBBIG1hcHBlciBmdW5jdGlvbiB0byBlYXNlIGZvcndhcmRpbmcgdGhlIGludGVyc2VjdGVkIGVsZW1lbnQgdG8gaXRzIHByb3BlciBvdXRwdXQgKi9cclxuICByZWFkb25seSByZWFjaGVkRXZlbnRBY3Rpb25zOiBSZWNvcmQ8c3RyaW5nLCBSZWFjaGVkRXZlbnRBY3Rpb24+ID0ge1xyXG4gICAgdG9wOiB7IGVtaXQ6ICgpOiB2b2lkID0+IHRoaXMuc2Nyb2xsYmFyLmlzVmVydGljYWxseVNjcm9sbGFibGUoKSA/IHRoaXMucmVhY2hlZFRvcC5lbWl0KCkgOiBudWxsIH0sXHJcbiAgICBib3R0b206IHsgZW1pdDogKCk6IHZvaWQgPT4gdGhpcy5zY3JvbGxiYXIuaXNWZXJ0aWNhbGx5U2Nyb2xsYWJsZSgpID8gdGhpcy5yZWFjaGVkQm90dG9tLmVtaXQoKSA6IG51bGwgfSxcclxuICAgIHN0YXJ0OiB7IGVtaXQ6ICgpOiB2b2lkID0+IHRoaXMuc2Nyb2xsYmFyLmlzSG9yaXpvbnRhbGx5U2Nyb2xsYWJsZSgpID8gdGhpcy5yZWFjaGVkU3RhcnQuZW1pdCgpIDogbnVsbCB9LFxyXG4gICAgZW5kOiB7IGVtaXQ6ICgpOiB2b2lkID0+IHRoaXMuc2Nyb2xsYmFyLmlzSG9yaXpvbnRhbGx5U2Nyb2xsYWJsZSgpID8gdGhpcy5yZWFjaGVkRW5kLmVtaXQoKSA6IG51bGwgfVxyXG4gIH07XHJcblxyXG4gIHByaXZhdGUgb25SZWFjaGVkKHRyaWdnZXI6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgaWYgKHRyaWdnZXIpIHtcclxuICAgICAgdGhpcy5yZWFjaGVkRXZlbnRBY3Rpb25zW3RyaWdnZXJdPy5lbWl0KCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFjdGl2YXRlKCk6IHZvaWQge1xyXG4gICAgdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcclxuICAgICAgLy8gQ3JlYXRlIHRoZSBzY3JvbGxiYXJzIGVsZW1lbnQgaW5zaWRlIHRoZSB2aWV3cG9ydFxyXG4gICAgICB0aGlzLnRyaWdnZXJFbGVtZW50c1dyYXBwZXIgPSB0aGlzLnJlbmRlcmVyLmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKHRoaXMudHJpZ2dlckVsZW1lbnRzV3JhcHBlciwgJ25nLXNjcm9sbC1yZWFjaGVkLXdyYXBwZXInKTtcclxuICAgICAgdGhpcy5yZW5kZXJlci5hcHBlbmRDaGlsZCh0aGlzLnNjcm9sbGJhci52aWV3cG9ydC5jb250ZW50V3JhcHBlckVsZW1lbnQsIHRoaXMudHJpZ2dlckVsZW1lbnRzV3JhcHBlcik7XHJcblxyXG4gICAgICAvLyBDcmVhdGUgYSB0cmlnZ2VyIGVsZW1lbnQgZm9yIGVhY2ggc3Vic2NyaWJlZCBldmVudFxyXG4gICAgICB0aGlzLnN1YnNjcmliZWRFdmVudHMuZm9yRWFjaCgoZXZlbnQ6IHN0cmluZykgPT4ge1xyXG4gICAgICAgIGNvbnN0IHRyaWdnZXJFbGVtZW50OiBIVE1MRWxlbWVudCA9IHRoaXMucmVuZGVyZXIuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyh0cmlnZ2VyRWxlbWVudCwgJ3Njcm9sbC1yZWFjaGVkLXRyaWdnZXItZWxlbWVudCcpO1xyXG4gICAgICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKHRyaWdnZXJFbGVtZW50LCAndHJpZ2dlcicsIGV2ZW50KTtcclxuICAgICAgICB0aGlzLnJlbmRlcmVyLmFwcGVuZENoaWxkKHRoaXMudHJpZ2dlckVsZW1lbnRzV3JhcHBlciwgdHJpZ2dlckVsZW1lbnQpO1xyXG4gICAgICAgIHRoaXMudHJpZ2dlckVsZW1lbnRzLnB1c2godHJpZ2dlckVsZW1lbnQpO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIC8vIFRoZSBmaXJzdCB0aW1lIHRoZSBvYnNlcnZlciBpcyB0cmlnZ2VyZWQgYXMgc29vbiBhcyB0aGUgZWxlbWVudCBpcyBvYnNlcnZlZCxcclxuICAgICAgLy8gVGhpcyBmbGFnIGlzIHVzZWQgdG8gaWdub3JlIHRoaXMgZmlyc3QgdHJpZ2dlclxyXG4gICAgICBsZXQgaW50ZXJzZWN0aW9uT2JzZXJ2ZXJJbml0OiBib29sZWFuID0gZmFsc2U7XHJcblxyXG4gICAgICB0aGlzLmludGVyc2VjdGlvbk9ic2VydmVyID0gbmV3IEludGVyc2VjdGlvbk9ic2VydmVyKChlbnRyaWVzOiBJbnRlcnNlY3Rpb25PYnNlcnZlckVudHJ5W10pID0+IHtcclxuICAgICAgICBpZiAoaW50ZXJzZWN0aW9uT2JzZXJ2ZXJJbml0KSB7XHJcbiAgICAgICAgICBlbnRyaWVzLmZvckVhY2goKGVudHJ5OiBJbnRlcnNlY3Rpb25PYnNlcnZlckVudHJ5KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlbnRyeS5pc0ludGVyc2VjdGluZykge1xyXG4gICAgICAgICAgICAgIC8vIEZvcndhcmQgdGhlIGRldGVjdGVkIHRyaWdnZXIgZWxlbWVudCBvbmx5IGFmdGVyIHRoZSBvYnNlcnZlciBpcyBpbml0aWFsaXplZFxyXG4gICAgICAgICAgICAgIC8vIE9ubHkgb2JzZXJ2ZSB0aGUgdHJpZ2dlciBlbGVtZW50cyB3aGVuIHNjcm9sbGFibGVcclxuICAgICAgICAgICAgICB0aGlzLnpvbmUucnVuKCgpID0+IHRoaXMub25SZWFjaGVkKGVudHJ5LnRhcmdldC5nZXRBdHRyaWJ1dGUoJ3RyaWdnZXInKSkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgLy8gT25jZSB0aGUgaW5pdGlhbCBlbGVtZW50IGlzIGRldGVjdGVkIHNldCBhIGZsYWcgdG8gdHJ1ZVxyXG4gICAgICAgICAgaW50ZXJzZWN0aW9uT2JzZXJ2ZXJJbml0ID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgIH0sIHtcclxuICAgICAgICByb290OiB0aGlzLnNjcm9sbGJhci52aWV3cG9ydC5uYXRpdmVFbGVtZW50LFxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHRoaXMudHJpZ2dlckVsZW1lbnRzLmZvckVhY2goKGVsOiBIVE1MRWxlbWVudCkgPT4gdGhpcy5pbnRlcnNlY3Rpb25PYnNlcnZlci5vYnNlcnZlKGVsKSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZGVhY3RpdmF0ZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuaW50ZXJzZWN0aW9uT2JzZXJ2ZXI/LmRpc2Nvbm5lY3QoKTtcclxuICAgIHRoaXMudHJpZ2dlckVsZW1lbnRzV3JhcHBlcj8ucmVtb3ZlKCk7XHJcbiAgICB0aGlzLnRyaWdnZXJFbGVtZW50cyA9IFtdO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZXRDc3NWYXJpYWJsZShwcm9wZXJ0eTogc3RyaW5nLCB2YWx1ZTogYW55KTogdm9pZCB7XHJcbiAgICBpZiAodmFsdWUpIHtcclxuICAgICAgdGhpcy5zY3JvbGxiYXIubmF0aXZlRWxlbWVudC5zdHlsZS5zZXRQcm9wZXJ0eShwcm9wZXJ0eSwgYCR7IHZhbHVlIH1weGApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5yZWFjaGVkVG9wLm9ic2VydmVkKSB7XHJcbiAgICAgIHRoaXMuc3Vic2NyaWJlZEV2ZW50cy5wdXNoKCd0b3AnKTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLnJlYWNoZWRCb3R0b20ub2JzZXJ2ZWQpIHtcclxuICAgICAgdGhpcy5zdWJzY3JpYmVkRXZlbnRzLnB1c2goJ2JvdHRvbScpO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMucmVhY2hlZFN0YXJ0Lm9ic2VydmVkKSB7XHJcbiAgICAgIHRoaXMuc3Vic2NyaWJlZEV2ZW50cy5wdXNoKCdzdGFydCcpO1xyXG4gICAgfVxyXG4gICAgaWYgKHRoaXMucmVhY2hlZEJvdHRvbS5vYnNlcnZlZCkge1xyXG4gICAgICB0aGlzLnN1YnNjcmliZWRFdmVudHMucHVzaCgnZW5kJyk7XHJcbiAgICB9XHJcblxyXG4gICAgcnVuSW5JbmplY3Rpb25Db250ZXh0KHRoaXMuaW5qZWN0b3IsICgpID0+IHtcclxuICAgICAgZWZmZWN0KCgpID0+IHtcclxuICAgICAgICBpZiAodGhpcy5kaXNhYmxlZCgpKSB7XHJcbiAgICAgICAgICB0aGlzLmRlYWN0aXZhdGUoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgaWYgKHRoaXMuaXNCcm93c2VyKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYWN0aXZhdGUoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgIHRoaXMuZGVhY3RpdmF0ZSgpO1xyXG4gIH1cclxufVxyXG4iXX0=
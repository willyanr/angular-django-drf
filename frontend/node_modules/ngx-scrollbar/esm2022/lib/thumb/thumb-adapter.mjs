import { Directive, inject, effect, NgZone, ElementRef } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { of, fromEvent, map, takeUntil, tap, switchMap } from 'rxjs';
import { enableSelection, preventSelection, stopPropagation } from '../utils/common';
import { TrackAdapter } from '../track/track-adapter';
import { NG_SCROLLBAR } from '../utils/scrollbar-base';
import { ScrollbarManager } from '../utils/scrollbar-manager';
import * as i0 from "@angular/core";
// @dynamic
export class ThumbAdapter {
    get trackMax() {
        return this.track.size - this.size;
    }
    // Get thumb client rect
    get clientRect() {
        return this.nativeElement.getBoundingClientRect();
    }
    /**
     * Stream that emits the 'scrollTo' position when a scrollbar thumb element is dragged
     * This function is called by thumb drag event using viewport or scrollbar pointer events
     */
    get dragged() {
        return fromEvent(this.nativeElement, 'pointerdown').pipe(stopPropagation(), switchMap((e) => {
            let trackMaxStart;
            let scrollMaxStart;
            const dragStart = of(e).pipe(preventSelection(this.document), tap(() => {
                // Capture scrollMax and trackMax once
                trackMaxStart = this.trackMax;
                scrollMaxStart = this.viewportScrollMax;
                this.setDragging(this.axis);
            }));
            const dragging = fromEvent(this.document, 'pointermove').pipe(stopPropagation());
            const dragEnd = fromEvent(this.document, 'pointerup', { capture: true }).pipe(stopPropagation(), enableSelection(this.document), tap(() => this.setDragging('none')));
            return dragStart.pipe(map((e) => e[this.pageProperty]), map((pageOffset) => pageOffset - this.dragStartOffset), switchMap((mouseDownOffset) => dragging.pipe(map((e) => e[this.clientProperty]), 
            // Calculate how far the pointer is from the top/left of the scrollbar (minus the dragOffset).
            map((mouseOffset) => mouseOffset - this.track.offset), map((offset) => scrollMaxStart * (offset - mouseDownOffset) / trackMaxStart), map((position) => this.handleDrag(position, scrollMaxStart)), tap((position) => this.scrollTo(position)), takeUntil(dragEnd))));
        }));
    }
    constructor() {
        this.zone = inject(NgZone);
        this.document = inject(DOCUMENT);
        this.cmp = inject(NG_SCROLLBAR);
        this.manager = inject(ScrollbarManager);
        this.track = inject(TrackAdapter);
        this.nativeElement = inject((ElementRef)).nativeElement;
        effect(() => {
            const script = this.manager.scrollTimelinePolyfill();
            if (script && !this.animation) {
                this.animation = startPolyfill(script, this.nativeElement, this.cmp.viewport.nativeElement, this.axis);
            }
        });
    }
    setDragging(value) {
        this.zone.run(() => this.cmp.dragging.set(value));
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.2.1", ngImport: i0, type: ThumbAdapter, deps: [], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "17.2.1", type: ThumbAdapter, ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.2.1", ngImport: i0, type: ThumbAdapter, decorators: [{
            type: Directive
        }], ctorParameters: () => [] });
function startPolyfill(ScrollTimeline, element, source, axis) {
    return element.animate({
        translate: [
            'var(--_scrollbar-thumb-transform-from)',
            'var(--_scrollbar-thumb-transform-to)'
        ]
    }, {
        fill: 'both',
        easing: 'linear',
        timeline: new ScrollTimeline({ source, axis })
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGh1bWItYWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25neC1zY3JvbGxiYXIvc3JjL2xpYi90aHVtYi90aHVtYi1hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzlFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMzQyxPQUFPLEVBQWMsRUFBRSxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDakYsT0FBTyxFQUFFLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxlQUFlLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNyRixPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDdEQsT0FBTyxFQUFFLFlBQVksRUFBZ0IsTUFBTSx5QkFBeUIsQ0FBQztBQUVyRSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQzs7QUFFOUQsV0FBVztBQUVYLE1BQU0sT0FBZ0IsWUFBWTtJQTRCaEMsSUFBSSxRQUFRO1FBQ1YsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ3JDLENBQUM7SUFFRCx3QkFBd0I7SUFDeEIsSUFBSSxVQUFVO1FBQ1osT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLHFCQUFxQixFQUFFLENBQUM7SUFDcEQsQ0FBQztJQUVEOzs7T0FHRztJQUNILElBQUksT0FBTztRQUNULE9BQU8sU0FBUyxDQUFlLElBQUksQ0FBQyxhQUFhLEVBQUUsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUNwRSxlQUFlLEVBQUUsRUFDakIsU0FBUyxDQUFDLENBQUMsQ0FBZSxFQUFFLEVBQUU7WUFDNUIsSUFBSSxhQUFxQixDQUFDO1lBQzFCLElBQUksY0FBc0IsQ0FBQztZQUUzQixNQUFNLFNBQVMsR0FBNkIsRUFBRSxDQUFlLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FDbEUsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUMvQixHQUFHLENBQUMsR0FBRyxFQUFFO2dCQUNQLHNDQUFzQztnQkFDdEMsYUFBYSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUM7Z0JBQzlCLGNBQWMsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUM7Z0JBQ3hDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzlCLENBQUMsQ0FBQyxDQUNILENBQUM7WUFFRixNQUFNLFFBQVEsR0FBNkIsU0FBUyxDQUFlLElBQUksQ0FBQyxRQUFRLEVBQUUsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLENBQUM7WUFFekgsTUFBTSxPQUFPLEdBQTZCLFNBQVMsQ0FBZSxJQUFJLENBQUMsUUFBUSxFQUFFLFdBQVcsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FDbkgsZUFBZSxFQUFFLEVBQ2pCLGVBQWUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQzlCLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQ3BDLENBQUM7WUFFRixPQUFPLFNBQVMsQ0FBQyxJQUFJLENBQ25CLEdBQUcsQ0FBQyxDQUFDLENBQWUsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxFQUM5QyxHQUFHLENBQUMsQ0FBQyxVQUFrQixFQUFFLEVBQUUsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxFQUM5RCxTQUFTLENBQUMsQ0FBQyxlQUF1QixFQUFFLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUNsRCxHQUFHLENBQUMsQ0FBQyxDQUFlLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7WUFDaEQsOEZBQThGO1lBQzlGLEdBQUcsQ0FBQyxDQUFDLFdBQW1CLEVBQUUsRUFBRSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxFQUM3RCxHQUFHLENBQUMsQ0FBQyxNQUFjLEVBQUUsRUFBRSxDQUFDLGNBQWMsR0FBRyxDQUFDLE1BQU0sR0FBRyxlQUFlLENBQUMsR0FBRyxhQUFhLENBQUMsRUFDcEYsR0FBRyxDQUFDLENBQUMsUUFBZ0IsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLEVBQUUsY0FBYyxDQUFDLENBQUMsRUFDcEUsR0FBRyxDQUFDLENBQUMsUUFBZ0IsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUNsRCxTQUFTLENBQUMsT0FBTyxDQUFDLENBQ25CLENBQUMsQ0FDSCxDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFFRDtRQWpGaUIsU0FBSSxHQUFXLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM1QixhQUFRLEdBQWEsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3RDLFFBQUcsR0FBaUIsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzNDLFlBQU8sR0FBcUIsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDckQsVUFBSyxHQUFpQixNQUFNLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDbkQsa0JBQWEsR0FBZ0IsTUFBTSxDQUFDLENBQUEsVUFBdUIsQ0FBQSxDQUFDLENBQUMsYUFBYSxDQUFDO1FBNkVsRixNQUFNLENBQUMsR0FBRyxFQUFFO1lBQ1YsTUFBTSxNQUFNLEdBQVEsSUFBSSxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsRUFBRSxDQUFDO1lBQzFELElBQUksTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtnQkFDN0IsSUFBSSxDQUFDLFNBQVMsR0FBRyxhQUFhLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsYUFBYSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUN4RztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVPLFdBQVcsQ0FBQyxLQUF3QjtRQUMxQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUNwRCxDQUFDOzhHQTlGbUIsWUFBWTtrR0FBWixZQUFZOzsyRkFBWixZQUFZO2tCQURqQyxTQUFTOztBQXdHVixTQUFTLGFBQWEsQ0FBQyxjQUFtQixFQUFFLE9BQW9CLEVBQUUsTUFBbUIsRUFBRSxJQUFlO0lBQ3BHLE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FDcEI7UUFDRSxTQUFTLEVBQUU7WUFDVCx3Q0FBd0M7WUFDeEMsc0NBQXNDO1NBQ3ZDO0tBQ0YsRUFDRDtRQUNFLElBQUksRUFBRSxNQUFNO1FBQ1osTUFBTSxFQUFFLFFBQVE7UUFDaEIsUUFBUSxFQUFFLElBQUksY0FBYyxDQUFDLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxDQUFDO0tBQ3hDLENBQ1QsQ0FBQztBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEaXJlY3RpdmUsIGluamVjdCwgZWZmZWN0LCBOZ1pvbmUsIEVsZW1lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgZnJvbUV2ZW50LCBtYXAsIHRha2VVbnRpbCwgdGFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgZW5hYmxlU2VsZWN0aW9uLCBwcmV2ZW50U2VsZWN0aW9uLCBzdG9wUHJvcGFnYXRpb24gfSBmcm9tICcuLi91dGlscy9jb21tb24nO1xyXG5pbXBvcnQgeyBUcmFja0FkYXB0ZXIgfSBmcm9tICcuLi90cmFjay90cmFjay1hZGFwdGVyJztcclxuaW1wb3J0IHsgTkdfU0NST0xMQkFSLCBfTmdTY3JvbGxiYXIgfSBmcm9tICcuLi91dGlscy9zY3JvbGxiYXItYmFzZSc7XHJcbmltcG9ydCB7IFNjcm9sbGJhckRyYWdnaW5nIH0gZnJvbSAnLi4vbmctc2Nyb2xsYmFyLm1vZGVsJztcclxuaW1wb3J0IHsgU2Nyb2xsYmFyTWFuYWdlciB9IGZyb20gJy4uL3V0aWxzL3Njcm9sbGJhci1tYW5hZ2VyJztcclxuXHJcbi8vIEBkeW5hbWljXHJcbkBEaXJlY3RpdmUoKVxyXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgVGh1bWJBZGFwdGVyIHtcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSB6b25lOiBOZ1pvbmUgPSBpbmplY3QoTmdab25lKTtcclxuICBwcm90ZWN0ZWQgcmVhZG9ubHkgZG9jdW1lbnQ6IERvY3VtZW50ID0gaW5qZWN0KERPQ1VNRU5UKTtcclxuICBwcm90ZWN0ZWQgcmVhZG9ubHkgY21wOiBfTmdTY3JvbGxiYXIgPSBpbmplY3QoTkdfU0NST0xMQkFSKTtcclxuICBwcml2YXRlIHJlYWRvbmx5IG1hbmFnZXI6IFNjcm9sbGJhck1hbmFnZXIgPSBpbmplY3QoU2Nyb2xsYmFyTWFuYWdlcik7XHJcbiAgcHJpdmF0ZSByZWFkb25seSB0cmFjazogVHJhY2tBZGFwdGVyID0gaW5qZWN0KFRyYWNrQWRhcHRlcik7XHJcbiAgcmVhZG9ubHkgbmF0aXZlRWxlbWVudDogSFRNTEVsZW1lbnQgPSBpbmplY3QoRWxlbWVudFJlZjxIVE1MRWxlbWVudD4pLm5hdGl2ZUVsZW1lbnQ7XHJcblxyXG4gIC8vIFJldHVybnMgZWl0aGVyICdwYWdlWCcgb3IgJ3BhZ2VZJyBhY2NvcmRpbmcgdG8gc2Nyb2xsYmFyIGF4aXNcclxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgZ2V0IHBhZ2VQcm9wZXJ0eSgpOiBzdHJpbmc7XHJcblxyXG4gIC8vIFJldHVybnMgZWl0aGVyICdjbGllbnRIZWlnaHQnIG9yICdjbGllbnRXaWR0aCcgYWNjb3JkaW5nIHRvIHNjcm9sbGJhciBheGlzXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldCBjbGllbnRQcm9wZXJ0eSgpOiBzdHJpbmc7XHJcblxyXG4gIGFic3RyYWN0IGdldCBkcmFnU3RhcnRPZmZzZXQoKTogbnVtYmVyO1xyXG5cclxuICBhYnN0cmFjdCBnZXQgb2Zmc2V0KCk6IG51bWJlcjtcclxuXHJcbiAgLy8gUmV0dXJucyB0aHVtYiBzaXplLCBjbGllbnRIZWlnaHQgb3IgY2xpZW50V2lkdGhcclxuICBhYnN0cmFjdCBnZXQgc2l6ZSgpOiBudW1iZXI7XHJcblxyXG4gIGFic3RyYWN0IGdldCB2aWV3cG9ydFNjcm9sbE1heCgpOiBudW1iZXI7XHJcblxyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBheGlzOiAneCcgfCAneSc7XHJcblxyXG4gIHByb3RlY3RlZCBhbmltYXRpb246IEFuaW1hdGlvbjtcclxuXHJcbiAgZ2V0IHRyYWNrTWF4KCk6IG51bWJlciB7XHJcbiAgICByZXR1cm4gdGhpcy50cmFjay5zaXplIC0gdGhpcy5zaXplO1xyXG4gIH1cclxuXHJcbiAgLy8gR2V0IHRodW1iIGNsaWVudCByZWN0XHJcbiAgZ2V0IGNsaWVudFJlY3QoKTogRE9NUmVjdCB7XHJcbiAgICByZXR1cm4gdGhpcy5uYXRpdmVFbGVtZW50LmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU3RyZWFtIHRoYXQgZW1pdHMgdGhlICdzY3JvbGxUbycgcG9zaXRpb24gd2hlbiBhIHNjcm9sbGJhciB0aHVtYiBlbGVtZW50IGlzIGRyYWdnZWRcclxuICAgKiBUaGlzIGZ1bmN0aW9uIGlzIGNhbGxlZCBieSB0aHVtYiBkcmFnIGV2ZW50IHVzaW5nIHZpZXdwb3J0IG9yIHNjcm9sbGJhciBwb2ludGVyIGV2ZW50c1xyXG4gICAqL1xyXG4gIGdldCBkcmFnZ2VkKCk6IE9ic2VydmFibGU8bnVtYmVyPiB7XHJcbiAgICByZXR1cm4gZnJvbUV2ZW50PFBvaW50ZXJFdmVudD4odGhpcy5uYXRpdmVFbGVtZW50LCAncG9pbnRlcmRvd24nKS5waXBlKFxyXG4gICAgICBzdG9wUHJvcGFnYXRpb24oKSxcclxuICAgICAgc3dpdGNoTWFwKChlOiBQb2ludGVyRXZlbnQpID0+IHtcclxuICAgICAgICBsZXQgdHJhY2tNYXhTdGFydDogbnVtYmVyO1xyXG4gICAgICAgIGxldCBzY3JvbGxNYXhTdGFydDogbnVtYmVyO1xyXG5cclxuICAgICAgICBjb25zdCBkcmFnU3RhcnQ6IE9ic2VydmFibGU8UG9pbnRlckV2ZW50PiA9IG9mPFBvaW50ZXJFdmVudD4oZSkucGlwZShcclxuICAgICAgICAgIHByZXZlbnRTZWxlY3Rpb24odGhpcy5kb2N1bWVudCksXHJcbiAgICAgICAgICB0YXAoKCkgPT4ge1xyXG4gICAgICAgICAgICAvLyBDYXB0dXJlIHNjcm9sbE1heCBhbmQgdHJhY2tNYXggb25jZVxyXG4gICAgICAgICAgICB0cmFja01heFN0YXJ0ID0gdGhpcy50cmFja01heDtcclxuICAgICAgICAgICAgc2Nyb2xsTWF4U3RhcnQgPSB0aGlzLnZpZXdwb3J0U2Nyb2xsTWF4O1xyXG4gICAgICAgICAgICB0aGlzLnNldERyYWdnaW5nKHRoaXMuYXhpcyk7XHJcbiAgICAgICAgICB9KSxcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICBjb25zdCBkcmFnZ2luZzogT2JzZXJ2YWJsZTxQb2ludGVyRXZlbnQ+ID0gZnJvbUV2ZW50PFBvaW50ZXJFdmVudD4odGhpcy5kb2N1bWVudCwgJ3BvaW50ZXJtb3ZlJykucGlwZShzdG9wUHJvcGFnYXRpb24oKSk7XHJcblxyXG4gICAgICAgIGNvbnN0IGRyYWdFbmQ6IE9ic2VydmFibGU8UG9pbnRlckV2ZW50PiA9IGZyb21FdmVudDxQb2ludGVyRXZlbnQ+KHRoaXMuZG9jdW1lbnQsICdwb2ludGVydXAnLCB7IGNhcHR1cmU6IHRydWUgfSkucGlwZShcclxuICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbigpLFxyXG4gICAgICAgICAgZW5hYmxlU2VsZWN0aW9uKHRoaXMuZG9jdW1lbnQpLFxyXG4gICAgICAgICAgdGFwKCgpID0+IHRoaXMuc2V0RHJhZ2dpbmcoJ25vbmUnKSlcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICByZXR1cm4gZHJhZ1N0YXJ0LnBpcGUoXHJcbiAgICAgICAgICBtYXAoKGU6IFBvaW50ZXJFdmVudCkgPT4gZVt0aGlzLnBhZ2VQcm9wZXJ0eV0pLFxyXG4gICAgICAgICAgbWFwKChwYWdlT2Zmc2V0OiBudW1iZXIpID0+IHBhZ2VPZmZzZXQgLSB0aGlzLmRyYWdTdGFydE9mZnNldCksXHJcbiAgICAgICAgICBzd2l0Y2hNYXAoKG1vdXNlRG93bk9mZnNldDogbnVtYmVyKSA9PiBkcmFnZ2luZy5waXBlKFxyXG4gICAgICAgICAgICBtYXAoKGU6IFBvaW50ZXJFdmVudCkgPT4gZVt0aGlzLmNsaWVudFByb3BlcnR5XSksXHJcbiAgICAgICAgICAgIC8vIENhbGN1bGF0ZSBob3cgZmFyIHRoZSBwb2ludGVyIGlzIGZyb20gdGhlIHRvcC9sZWZ0IG9mIHRoZSBzY3JvbGxiYXIgKG1pbnVzIHRoZSBkcmFnT2Zmc2V0KS5cclxuICAgICAgICAgICAgbWFwKChtb3VzZU9mZnNldDogbnVtYmVyKSA9PiBtb3VzZU9mZnNldCAtIHRoaXMudHJhY2sub2Zmc2V0KSxcclxuICAgICAgICAgICAgbWFwKChvZmZzZXQ6IG51bWJlcikgPT4gc2Nyb2xsTWF4U3RhcnQgKiAob2Zmc2V0IC0gbW91c2VEb3duT2Zmc2V0KSAvIHRyYWNrTWF4U3RhcnQpLFxyXG4gICAgICAgICAgICBtYXAoKHBvc2l0aW9uOiBudW1iZXIpID0+IHRoaXMuaGFuZGxlRHJhZyhwb3NpdGlvbiwgc2Nyb2xsTWF4U3RhcnQpKSxcclxuICAgICAgICAgICAgdGFwKChwb3NpdGlvbjogbnVtYmVyKSA9PiB0aGlzLnNjcm9sbFRvKHBvc2l0aW9uKSksXHJcbiAgICAgICAgICAgIHRha2VVbnRpbChkcmFnRW5kKVxyXG4gICAgICAgICAgKSlcclxuICAgICAgICApO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgZWZmZWN0KCgpID0+IHtcclxuICAgICAgY29uc3Qgc2NyaXB0OiBhbnkgPSB0aGlzLm1hbmFnZXIuc2Nyb2xsVGltZWxpbmVQb2x5ZmlsbCgpO1xyXG4gICAgICBpZiAoc2NyaXB0ICYmICF0aGlzLmFuaW1hdGlvbikge1xyXG4gICAgICAgIHRoaXMuYW5pbWF0aW9uID0gc3RhcnRQb2x5ZmlsbChzY3JpcHQsIHRoaXMubmF0aXZlRWxlbWVudCwgdGhpcy5jbXAudmlld3BvcnQubmF0aXZlRWxlbWVudCwgdGhpcy5heGlzKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNldERyYWdnaW5nKHZhbHVlOiBTY3JvbGxiYXJEcmFnZ2luZyk6IHZvaWQge1xyXG4gICAgdGhpcy56b25lLnJ1bigoKSA9PiB0aGlzLmNtcC5kcmFnZ2luZy5zZXQodmFsdWUpKTtcclxuICB9XHJcblxyXG4gIC8vIFNjcm9sbCB2aWV3cG9ydCBpbnN0YW50bHlcclxuICBwcm90ZWN0ZWQgYWJzdHJhY3Qgc2Nyb2xsVG8ocG9zaXRpb246IG51bWJlcik6IHZvaWQ7XHJcblxyXG4gIC8vIEhhbmRsZSBkcmFnZ2luZyBwb3NpdGlvbiAoU3VwcG9ydCBMVFIgYW5kIFJUTCBkaXJlY3Rpb25zIGZvciB0aGUgaG9yaXpvbnRhbCBzY3JvbGxiYXIpXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGhhbmRsZURyYWcocG9zaXRpb246IG51bWJlciwgc2Nyb2xsTWF4PzogbnVtYmVyKTogbnVtYmVyO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzdGFydFBvbHlmaWxsKFNjcm9sbFRpbWVsaW5lOiBhbnksIGVsZW1lbnQ6IEhUTUxFbGVtZW50LCBzb3VyY2U6IEhUTUxFbGVtZW50LCBheGlzOiAneCcgfCAneScpOiBBbmltYXRpb24ge1xyXG4gIHJldHVybiBlbGVtZW50LmFuaW1hdGUoXHJcbiAgICB7XHJcbiAgICAgIHRyYW5zbGF0ZTogW1xyXG4gICAgICAgICd2YXIoLS1fc2Nyb2xsYmFyLXRodW1iLXRyYW5zZm9ybS1mcm9tKScsXHJcbiAgICAgICAgJ3ZhcigtLV9zY3JvbGxiYXItdGh1bWItdHJhbnNmb3JtLXRvKSdcclxuICAgICAgXVxyXG4gICAgfSxcclxuICAgIHtcclxuICAgICAgZmlsbDogJ2JvdGgnLFxyXG4gICAgICBlYXNpbmc6ICdsaW5lYXInLFxyXG4gICAgICB0aW1lbGluZTogbmV3IFNjcm9sbFRpbWVsaW5lKHsgc291cmNlLCBheGlzIH0pXHJcbiAgICB9IGFzIGFueVxyXG4gICk7XHJcbn1cclxuIl19
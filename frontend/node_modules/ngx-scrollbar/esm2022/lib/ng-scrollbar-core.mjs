import { Directive, Input, Output, inject, signal, effect, computed, numberAttribute, booleanAttribute, runInInjectionContext, input, EventEmitter, ElementRef, NgZone, Injector } from '@angular/core';
import { Platform } from '@angular/cdk/platform';
import { Directionality } from '@angular/cdk/bidi';
import { toSignal } from '@angular/core/rxjs-interop';
import { map, tap } from 'rxjs';
import { SmoothScrollManager } from 'ngx-scrollbar/smooth-scroll';
import { NG_SCROLLBAR } from './utils/scrollbar-base';
import { resizeSensor } from './viewport';
import { ScrollbarManager } from './utils/scrollbar-manager';
import { ScrollbarUpdateReason } from './ng-scrollbar.model';
import * as i0 from "@angular/core";
export class NgScrollbarCore {
    constructor() {
        this.platform = inject(Platform);
        this.zone = inject(NgZone);
        this.injector = inject(Injector);
        this.isMobile = this.platform.SAFARI || this.platform.ANDROID;
        this.dir = inject(Directionality);
        this.manager = inject(ScrollbarManager);
        this.smoothScroll = inject(SmoothScrollManager);
        this.nativeElement = inject((ElementRef)).nativeElement;
        this.rtlScrollAxisType = this.manager.rtlScrollAxisType;
        /**
         * Indicates when scrollbar thumb is being dragged
         */
        this.dragging = signal('none');
        /**
         * Sets the supported scroll track of the viewport, there are 3 options:
         *
         * - `vertical` Use both vertical and horizontal scrollbar
         * - `horizontal` Use both vertical and horizontal scrollbar
         * - `auto` Use both vertical and horizontal scrollbar
         */
        this.orientation = input(this.manager.globalOptions.orientation);
        /**
         * When to show the scrollbar, and there are 3 options:
         *
         * - `native` (default) Scrollbar will be visible when viewport is scrollable like with native scrollbar
         * - `hover` Scrollbars are hidden by default, only visible on scrolling or hovering
         * - `always` Scrollbars are always shown even if the viewport is not scrollable
         */
        this.visibility = input(this.manager.globalOptions.visibility);
        /** Disables scrollbar interaction like dragging thumb and jumping by track click */
        this.disableInteraction = input(this.manager.globalOptions.disableInteraction, {
            transform: booleanAttribute
        });
        /** A computed signal for disabling the interaction */
        this.interactionDisabled = computed(() => {
            return this.isMobile || this.disableInteraction();
        });
        /** Whether ResizeObserver is disabled */
        this.disableSensor = input(this.manager.globalOptions.disableSensor, {
            transform: booleanAttribute
        });
        /** Throttle interval for detecting changes via ResizeObserver */
        this.sensorThrottleTime = input(this.manager.globalOptions.sensorThrottleTime, {
            transform: numberAttribute
        });
        this.viewportDimension = signal({
            contentHeight: 0,
            contentWidth: 0,
            offsetHeight: 0,
            offsetWidth: 0
        });
        this.state = computed(() => {
            let verticalUsed = false;
            let horizontalUsed = false;
            let isVerticallyScrollable = false;
            let isHorizontallyScrollable = false;
            const orientation = this.orientation();
            const visibility = this.visibility();
            const viewport = this.viewportDimension();
            // Check if vertical scrollbar should be displayed
            if (orientation === 'auto' || orientation === 'vertical') {
                isVerticallyScrollable = viewport.contentHeight > viewport.offsetHeight;
                verticalUsed = visibility === 'always' || isVerticallyScrollable;
            }
            // Check if horizontal scrollbar should be displayed
            if (orientation === 'auto' || orientation === 'horizontal') {
                isHorizontallyScrollable = viewport.contentWidth > viewport.offsetWidth;
                horizontalUsed = visibility === 'always' || isHorizontallyScrollable;
            }
            return {
                verticalUsed,
                horizontalUsed,
                isVerticallyScrollable,
                isHorizontallyScrollable,
            };
        });
        this.isVerticallyScrollable = computed(() => this.state().isVerticallyScrollable);
        this.isHorizontallyScrollable = computed(() => this.state().isHorizontallyScrollable);
        this.verticalUsed = computed(() => this.state().verticalUsed);
        this.horizontalUsed = computed(() => this.state().horizontalUsed);
        /** Scroll duration when the scroll track is clicked */
        this.trackClickDuration = this.manager.globalOptions.clickScrollDuration;
        /**
         *  Sets the appearance of the scrollbar, there are 2 options:
         *
         * - `standard` (default) scrollbar space will be reserved just like with native scrollbar.
         * - `compact` scrollbar doesn't reserve any space, they are placed over the viewport.
         */
        this.appearance = this.manager.globalOptions.appearance;
        /**
         * Sets the position of each scrollbar, there are 4 options:
         *
         * - `native` (Default) Use the default position like in native scrollbar.
         * - `invertY` Inverts vertical scrollbar position
         * - `invertX` Inverts Horizontal scrollbar position
         * - `invertAll` Inverts both scrollbar positions
         */
        this.position = this.manager.globalOptions.position;
        /** A class forwarded to the scrollbar track element */
        this.trackClass = this.manager.globalOptions.trackClass;
        /** A class forwarded to the scrollbar thumb element */
        this.thumbClass = this.manager.globalOptions.thumbClass;
        /** Steam that emits when scrollbar is initialized */
        this.afterInit = new EventEmitter();
        /** Steam that emits when scrollbar is updated */
        this.afterUpdate = new EventEmitter();
    }
    ngOnInit() {
        runInInjectionContext(this.injector, () => {
            // The direction signal cannot be initialized in the constructor
            // Because it initially returns 'ltr' even if dir.value is 'rtl`
            this.direction = toSignal(this.dir.change.pipe(map(() => this.dir.value)), { initialValue: this.dir.value });
            effect((onCleanup) => {
                // Check whether sensor should be enabled
                if (this.disableSensor()) {
                    // If sensor is disabled update manually
                    this.sizeChangeSub?.unsubscribe();
                }
                else {
                    if (this.platform.isBrowser) {
                        this.sizeChangeSub?.unsubscribe();
                        this.sizeChangeSub = resizeSensor(this.viewport.nativeElement, this.sensorThrottleTime()).pipe(tap((reason) => this.update(reason))).subscribe();
                    }
                }
                onCleanup(() => this.sizeChangeSub?.unsubscribe());
            });
        });
    }
    ngAfterViewInit() {
        // If sensor is disabled, update to evaluate the state
        if (this.platform.isBrowser && this.disableSensor()) {
            // In case of 3rd party library, need to wait for content to be rendered
            requestAnimationFrame(() => {
                this.update(ScrollbarUpdateReason.AfterInit);
            });
        }
    }
    /**
     * Update local state and the internal scrollbar controls
     */
    update(reason) {
        this.updateCSSVariables();
        this.zone.run(() => {
            this.viewportDimension.set({
                contentHeight: this.viewport.contentHeight,
                contentWidth: this.viewport.contentWidth,
                offsetHeight: this.viewport.offsetHeight,
                offsetWidth: this.viewport.offsetWidth
            });
            if (reason === ScrollbarUpdateReason.AfterInit) {
                this.afterInit.emit();
            }
            else {
                this.afterUpdate.emit();
            }
        });
    }
    /**
     * Smooth scroll functions
     */
    scrollTo(options) {
        return this.smoothScroll.scrollTo(this.viewport.nativeElement, {
            duration: this.trackClickDuration,
            ...options
        });
    }
    /**
     * Scroll to element by reference or selector
     */
    scrollToElement(target, options) {
        return this.smoothScroll.scrollToElement(this.viewport.nativeElement, target, options);
    }
    /**
     * Update Essential CSS variables
     */
    updateCSSVariables() {
        this.nativeElement.style.setProperty('--content-height', `${this.viewport.contentHeight}`);
        this.nativeElement.style.setProperty('--content-width', `${this.viewport.contentWidth}`);
        this.nativeElement.style.setProperty('--viewport-height', `${this.viewport.offsetHeight}`);
        this.nativeElement.style.setProperty('--viewport-width', `${this.viewport.offsetWidth}`);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.2.1", ngImport: i0, type: NgScrollbarCore, deps: [], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "17.1.0", version: "17.2.1", type: NgScrollbarCore, inputs: { orientation: { classPropertyName: "orientation", publicName: "orientation", isSignal: true, isRequired: false, transformFunction: null }, visibility: { classPropertyName: "visibility", publicName: "visibility", isSignal: true, isRequired: false, transformFunction: null }, disableInteraction: { classPropertyName: "disableInteraction", publicName: "disableInteraction", isSignal: true, isRequired: false, transformFunction: null }, disableSensor: { classPropertyName: "disableSensor", publicName: "disableSensor", isSignal: true, isRequired: false, transformFunction: null }, sensorThrottleTime: { classPropertyName: "sensorThrottleTime", publicName: "sensorThrottleTime", isSignal: true, isRequired: false, transformFunction: null }, trackClickDuration: { classPropertyName: "trackClickDuration", publicName: "clickScrollDuration", isSignal: false, isRequired: false, transformFunction: numberAttribute }, appearance: { classPropertyName: "appearance", publicName: "appearance", isSignal: false, isRequired: false, transformFunction: null }, position: { classPropertyName: "position", publicName: "position", isSignal: false, isRequired: false, transformFunction: null }, trackClass: { classPropertyName: "trackClass", publicName: "trackClass", isSignal: false, isRequired: false, transformFunction: null }, thumbClass: { classPropertyName: "thumbClass", publicName: "thumbClass", isSignal: false, isRequired: false, transformFunction: null } }, outputs: { afterInit: "afterInit", afterUpdate: "afterUpdate" }, host: { properties: { "class.ng-scrollbar": "true", "attr.verticalUsed": "verticalUsed()", "attr.horizontalUsed": "horizontalUsed()", "attr.isVerticallyScrollable": "isVerticallyScrollable()", "attr.isHorizontallyScrollable": "isHorizontallyScrollable()", "attr.mobile": "isMobile", "attr.dir": "direction()", "attr.position": "position", "attr.dragging": "dragging()", "attr.appearance": "appearance", "attr.visibility": "visibility()", "attr.orientation": "orientation()", "attr.disableInteraction": "interactionDisabled()" } }, providers: [{ provide: NG_SCROLLBAR, useExisting: NgScrollbarCore }], ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.2.1", ngImport: i0, type: NgScrollbarCore, decorators: [{
            type: Directive,
            args: [{
                    host: {
                        '[class.ng-scrollbar]': 'true',
                        '[attr.verticalUsed]': 'verticalUsed()',
                        '[attr.horizontalUsed]': 'horizontalUsed()',
                        '[attr.isVerticallyScrollable]': 'isVerticallyScrollable()',
                        '[attr.isHorizontallyScrollable]': 'isHorizontallyScrollable()',
                        '[attr.mobile]': 'isMobile',
                        '[attr.dir]': 'direction()',
                        '[attr.position]': 'position',
                        '[attr.dragging]': 'dragging()',
                        '[attr.appearance]': 'appearance',
                        '[attr.visibility]': 'visibility()',
                        '[attr.orientation]': 'orientation()',
                        '[attr.disableInteraction]': 'interactionDisabled()'
                    },
                    providers: [{ provide: NG_SCROLLBAR, useExisting: NgScrollbarCore }]
                }]
        }], propDecorators: { trackClickDuration: [{
                type: Input,
                args: [{
                        alias: 'clickScrollDuration',
                        transform: numberAttribute
                    }]
            }], appearance: [{
                type: Input
            }], position: [{
                type: Input
            }], trackClass: [{
                type: Input
            }], thumbClass: [{
                type: Input
            }], afterInit: [{
                type: Output
            }], afterUpdate: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctc2Nyb2xsYmFyLWNvcmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtc2Nyb2xsYmFyL3NyYy9saWIvbmctc2Nyb2xsYmFyLWNvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLFNBQVMsRUFDVCxLQUFLLEVBQ0wsTUFBTSxFQUNOLE1BQU0sRUFDTixNQUFNLEVBQ04sTUFBTSxFQUNOLFFBQVEsRUFDUixlQUFlLEVBQ2YsZ0JBQWdCLEVBQ2hCLHFCQUFxQixFQUNyQixLQUFLLEVBQ0wsWUFBWSxFQUdaLFVBQVUsRUFDVixNQUFNLEVBR04sUUFBUSxFQUlULE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxRQUFRLEVBQXFCLE1BQU0sdUJBQXVCLENBQUM7QUFDcEUsT0FBTyxFQUFhLGNBQWMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzlELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUN0RCxPQUFPLEVBQWdCLEdBQUcsRUFBRSxHQUFHLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFFOUMsT0FBTyxFQUVMLG1CQUFtQixFQUdwQixNQUFNLDZCQUE2QixDQUFDO0FBRXJDLE9BQU8sRUFBZ0IsWUFBWSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDcEUsT0FBTyxFQUFFLFlBQVksRUFBbUIsTUFBTSxZQUFZLENBQUM7QUFDM0QsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDN0QsT0FBTyxFQUtMLHFCQUFxQixFQUd0QixNQUFNLHNCQUFzQixDQUFDOztBQTJCOUIsTUFBTSxPQUFnQixlQUFlO0lBbEJyQztRQW9CbUIsYUFBUSxHQUFhLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN0QyxTQUFJLEdBQVcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzlCLGFBQVEsR0FBYSxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFOUMsYUFBUSxHQUFZLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDO1FBRTNFLFFBQUcsR0FBbUIsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBRTdDLFlBQU8sR0FBcUIsTUFBTSxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFFckQsaUJBQVksR0FBd0IsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFFaEUsa0JBQWEsR0FBZ0IsTUFBTSxDQUFDLENBQUEsVUFBdUIsQ0FBQSxDQUFDLENBQUMsYUFBYSxDQUFDO1FBRTNFLHNCQUFpQixHQUFzQixJQUFJLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDO1FBSXRFOztXQUVHO1FBQ0gsYUFBUSxHQUFzQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFN0Q7Ozs7OztXQU1HO1FBQ0gsZ0JBQVcsR0FBc0MsS0FBSyxDQUF1QixJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUVySDs7Ozs7O1dBTUc7UUFDSCxlQUFVLEdBQXFDLEtBQUssQ0FBc0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFakgsb0ZBQW9GO1FBQ3BGLHVCQUFrQixHQUF3RCxLQUFLLENBQTRCLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLGtCQUFrQixFQUFFO1lBQ3hKLFNBQVMsRUFBRSxnQkFBZ0I7U0FDNUIsQ0FBQyxDQUFDO1FBRUgsc0RBQXNEO1FBQ3RELHdCQUFtQixHQUFvQixRQUFRLENBQUMsR0FBRyxFQUFFO1lBQ25ELE9BQU8sSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztRQUNwRCxDQUFDLENBQUMsQ0FBQztRQUVILHlDQUF5QztRQUN6QyxrQkFBYSxHQUF3RCxLQUFLLENBQTRCLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLGFBQWEsRUFBRTtZQUM5SSxTQUFTLEVBQUUsZ0JBQWdCO1NBQzVCLENBQUMsQ0FBQztRQUVILGlFQUFpRTtRQUNqRSx1QkFBa0IsR0FBd0IsS0FBSyxDQUFpQixJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxrQkFBa0IsRUFBRTtZQUM3RyxTQUFTLEVBQUUsZUFBZTtTQUMzQixDQUFDLENBQUM7UUFFSCxzQkFBaUIsR0FBdUMsTUFBTSxDQUFDO1lBQzdELGFBQWEsRUFBRSxDQUFDO1lBQ2hCLFlBQVksRUFBRSxDQUFDO1lBQ2YsWUFBWSxFQUFFLENBQUM7WUFDZixXQUFXLEVBQUUsQ0FBQztTQUNmLENBQUMsQ0FBQztRQUVILFVBQUssR0FBMEIsUUFBUSxDQUFDLEdBQUcsRUFBRTtZQUMzQyxJQUFJLFlBQVksR0FBWSxLQUFLLENBQUM7WUFDbEMsSUFBSSxjQUFjLEdBQVksS0FBSyxDQUFDO1lBQ3BDLElBQUksc0JBQXNCLEdBQVksS0FBSyxDQUFDO1lBQzVDLElBQUksd0JBQXdCLEdBQVksS0FBSyxDQUFDO1lBRTlDLE1BQU0sV0FBVyxHQUF5QixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDN0QsTUFBTSxVQUFVLEdBQXdCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUMxRCxNQUFNLFFBQVEsR0FBdUIsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7WUFFOUQsa0RBQWtEO1lBQ2xELElBQUksV0FBVyxLQUFLLE1BQU0sSUFBSSxXQUFXLEtBQUssVUFBVSxFQUFFO2dCQUN4RCxzQkFBc0IsR0FBRyxRQUFRLENBQUMsYUFBYSxHQUFHLFFBQVEsQ0FBQyxZQUFZLENBQUM7Z0JBQ3hFLFlBQVksR0FBRyxVQUFVLEtBQUssUUFBUSxJQUFJLHNCQUFzQixDQUFDO2FBQ2xFO1lBQ0Qsb0RBQW9EO1lBQ3BELElBQUksV0FBVyxLQUFLLE1BQU0sSUFBSSxXQUFXLEtBQUssWUFBWSxFQUFFO2dCQUMxRCx3QkFBd0IsR0FBRyxRQUFRLENBQUMsWUFBWSxHQUFHLFFBQVEsQ0FBQyxXQUFXLENBQUM7Z0JBQ3hFLGNBQWMsR0FBRyxVQUFVLEtBQUssUUFBUSxJQUFJLHdCQUF3QixDQUFDO2FBQ3RFO1lBRUQsT0FBTztnQkFDTCxZQUFZO2dCQUNaLGNBQWM7Z0JBQ2Qsc0JBQXNCO2dCQUN0Qix3QkFBd0I7YUFDekIsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO1FBRUgsMkJBQXNCLEdBQW9CLFFBQVEsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsc0JBQXNCLENBQUMsQ0FBQztRQUM5Riw2QkFBd0IsR0FBb0IsUUFBUSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1FBQ2xHLGlCQUFZLEdBQW9CLFFBQVEsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDMUUsbUJBQWMsR0FBb0IsUUFBUSxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUU5RSx1REFBdUQ7UUFJcEQsdUJBQWtCLEdBQVcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsbUJBQW1CLENBQUM7UUFFL0U7Ozs7O1dBS0c7UUFDTSxlQUFVLEdBQXdCLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQztRQUNqRjs7Ozs7OztXQU9HO1FBQ00sYUFBUSxHQUFzQixJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUM7UUFFM0UsdURBQXVEO1FBQzlDLGVBQVUsR0FBVyxJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUM7UUFDcEUsdURBQXVEO1FBQzlDLGVBQVUsR0FBVyxJQUFJLENBQUMsT0FBTyxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUM7UUFFcEUscURBQXFEO1FBQzNDLGNBQVMsR0FBdUIsSUFBSSxZQUFZLEVBQVEsQ0FBQztRQUVuRSxpREFBaUQ7UUFDdkMsZ0JBQVcsR0FBdUIsSUFBSSxZQUFZLEVBQVEsQ0FBQztLQTZGdEU7SUFwRkMsUUFBUTtRQUNOLHFCQUFxQixDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsR0FBRyxFQUFFO1lBQ3hDLGdFQUFnRTtZQUNoRSxnRUFBZ0U7WUFDaEUsSUFBSSxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQXVCLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLEVBQUUsWUFBWSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUVuSSxNQUFNLENBQUMsQ0FBQyxTQUFrQyxFQUFFLEVBQUU7Z0JBQzVDLHlDQUF5QztnQkFDekMsSUFBSSxJQUFJLENBQUMsYUFBYSxFQUFFLEVBQUU7b0JBQ3hCLHdDQUF3QztvQkFDeEMsSUFBSSxDQUFDLGFBQWEsRUFBRSxXQUFXLEVBQUUsQ0FBQztpQkFDbkM7cUJBQU07b0JBQ0wsSUFBSSxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsRUFBRTt3QkFDM0IsSUFBSSxDQUFDLGFBQWEsRUFBRSxXQUFXLEVBQUUsQ0FBQzt3QkFFbEMsSUFBSSxDQUFDLGFBQWEsR0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQzVGLEdBQUcsQ0FBQyxDQUFDLE1BQTZCLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FDNUQsQ0FBQyxTQUFTLEVBQUUsQ0FBQztxQkFDZjtpQkFDRjtnQkFFRCxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO1lBQ3JELENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsZUFBZTtRQUNiLHNEQUFzRDtRQUN0RCxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUUsRUFBRTtZQUNuRCx3RUFBd0U7WUFDeEUscUJBQXFCLENBQUMsR0FBRyxFQUFFO2dCQUN6QixJQUFJLENBQUMsTUFBTSxDQUFDLHFCQUFxQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQy9DLENBQUMsQ0FBQyxDQUFDO1NBQ0o7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsTUFBOEI7UUFDbkMsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFFMUIsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFO1lBQ2pCLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLENBQUM7Z0JBQ3pCLGFBQWEsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWE7Z0JBQzFDLFlBQVksRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVk7Z0JBQ3hDLFlBQVksRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVk7Z0JBQ3hDLFdBQVcsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVc7YUFDdkMsQ0FBQyxDQUFDO1lBRUgsSUFBSSxNQUFNLEtBQUsscUJBQXFCLENBQUMsU0FBUyxFQUFFO2dCQUM5QyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDO2FBQ3ZCO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLENBQUM7YUFDekI7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNILFFBQVEsQ0FBQyxPQUE4QjtRQUNyQyxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUFTLENBQUMsYUFBYSxFQUFFO1lBQzlELFFBQVEsRUFBRSxJQUFJLENBQUMsa0JBQWtCO1lBQ2pDLEdBQUcsT0FBTztTQUNYLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNILGVBQWUsQ0FBQyxNQUEyQixFQUFFLE9BQXNDO1FBQ2pGLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3pGLENBQUM7SUFFRDs7T0FFRztJQUNLLGtCQUFrQjtRQUN4QixJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsa0JBQWtCLEVBQUUsR0FBSSxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWMsRUFBRSxDQUFDLENBQUM7UUFDN0YsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLGlCQUFpQixFQUFFLEdBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxZQUFhLEVBQUUsQ0FBQyxDQUFDO1FBQzNGLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxtQkFBbUIsRUFBRSxHQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsWUFBYSxFQUFFLENBQUMsQ0FBQztRQUM3RixJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsa0JBQWtCLEVBQUUsR0FBSSxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVksRUFBRSxDQUFDLENBQUM7SUFDN0YsQ0FBQzs4R0FwT21CLGVBQWU7a0dBQWYsZUFBZSxvNEJBMkd0QixlQUFlLCtuQ0E3R2pCLENBQUMsRUFBRSxPQUFPLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxlQUFlLEVBQUUsQ0FBQzs7MkZBRWhELGVBQWU7a0JBbEJwQyxTQUFTO21CQUFDO29CQUNULElBQUksRUFBRTt3QkFDSixzQkFBc0IsRUFBRSxNQUFNO3dCQUM5QixxQkFBcUIsRUFBRSxnQkFBZ0I7d0JBQ3ZDLHVCQUF1QixFQUFFLGtCQUFrQjt3QkFDM0MsK0JBQStCLEVBQUUsMEJBQTBCO3dCQUMzRCxpQ0FBaUMsRUFBRSw0QkFBNEI7d0JBQy9ELGVBQWUsRUFBRSxVQUFVO3dCQUMzQixZQUFZLEVBQUUsYUFBYTt3QkFDM0IsaUJBQWlCLEVBQUUsVUFBVTt3QkFDN0IsaUJBQWlCLEVBQUUsWUFBWTt3QkFDL0IsbUJBQW1CLEVBQUUsWUFBWTt3QkFDakMsbUJBQW1CLEVBQUUsY0FBYzt3QkFDbkMsb0JBQW9CLEVBQUUsZUFBZTt3QkFDckMsMkJBQTJCLEVBQUUsdUJBQXVCO3FCQUNyRDtvQkFDRCxTQUFTLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxZQUFZLEVBQUUsV0FBVyxpQkFBaUIsRUFBRSxDQUFDO2lCQUNyRTs4QkE2R0ksa0JBQWtCO3NCQUhwQixLQUFLO3VCQUFDO3dCQUNMLEtBQUssRUFBRSxxQkFBcUI7d0JBQzVCLFNBQVMsRUFBRSxlQUFlO3FCQUMzQjtnQkFRUSxVQUFVO3NCQUFsQixLQUFLO2dCQVNHLFFBQVE7c0JBQWhCLEtBQUs7Z0JBR0csVUFBVTtzQkFBbEIsS0FBSztnQkFFRyxVQUFVO3NCQUFsQixLQUFLO2dCQUdJLFNBQVM7c0JBQWxCLE1BQU07Z0JBR0csV0FBVztzQkFBcEIsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgRGlyZWN0aXZlLFxyXG4gIElucHV0LFxyXG4gIE91dHB1dCxcclxuICBpbmplY3QsXHJcbiAgc2lnbmFsLFxyXG4gIGVmZmVjdCxcclxuICBjb21wdXRlZCxcclxuICBudW1iZXJBdHRyaWJ1dGUsXHJcbiAgYm9vbGVhbkF0dHJpYnV0ZSxcclxuICBydW5JbkluamVjdGlvbkNvbnRleHQsXHJcbiAgaW5wdXQsXHJcbiAgRXZlbnRFbWl0dGVyLFxyXG4gIE9uSW5pdCxcclxuICBBZnRlclZpZXdJbml0LFxyXG4gIEVsZW1lbnRSZWYsXHJcbiAgTmdab25lLFxyXG4gIFNpZ25hbCxcclxuICBJbnB1dFNpZ25hbCxcclxuICBJbmplY3RvcixcclxuICBXcml0YWJsZVNpZ25hbCxcclxuICBFZmZlY3RDbGVhbnVwUmVnaXN0ZXJGbixcclxuICBJbnB1dFNpZ25hbFdpdGhUcmFuc2Zvcm1cclxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgUGxhdGZvcm0sIFJ0bFNjcm9sbEF4aXNUeXBlIH0gZnJvbSAnQGFuZ3VsYXIvY2RrL3BsYXRmb3JtJztcclxuaW1wb3J0IHsgRGlyZWN0aW9uLCBEaXJlY3Rpb25hbGl0eSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9iaWRpJztcclxuaW1wb3J0IHsgdG9TaWduYWwgfSBmcm9tICdAYW5ndWxhci9jb3JlL3J4anMtaW50ZXJvcCc7XHJcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiwgbWFwLCB0YXAgfSBmcm9tICdyeGpzJztcclxuXHJcbmltcG9ydCB7XHJcbiAgU21vb3RoU2Nyb2xsRWxlbWVudCxcclxuICBTbW9vdGhTY3JvbGxNYW5hZ2VyLFxyXG4gIFNtb290aFNjcm9sbFRvRWxlbWVudE9wdGlvbnMsXHJcbiAgU21vb3RoU2Nyb2xsVG9PcHRpb25zXHJcbn0gZnJvbSAnbmd4LXNjcm9sbGJhci9zbW9vdGgtc2Nyb2xsJztcclxuaW1wb3J0IHsgU2Nyb2xsYmFycyB9IGZyb20gJy4vc2Nyb2xsYmFycy9zY3JvbGxiYXJzJztcclxuaW1wb3J0IHsgX05nU2Nyb2xsYmFyLCBOR19TQ1JPTExCQVIgfSBmcm9tICcuL3V0aWxzL3Njcm9sbGJhci1iYXNlJztcclxuaW1wb3J0IHsgcmVzaXplU2Vuc29yLCBWaWV3cG9ydEFkYXB0ZXIgfSBmcm9tICcuL3ZpZXdwb3J0JztcclxuaW1wb3J0IHsgU2Nyb2xsYmFyTWFuYWdlciB9IGZyb20gJy4vdXRpbHMvc2Nyb2xsYmFyLW1hbmFnZXInO1xyXG5pbXBvcnQge1xyXG4gIFNjcm9sbGJhckFwcGVhcmFuY2UsXHJcbiAgU2Nyb2xsYmFyRHJhZ2dpbmcsXHJcbiAgU2Nyb2xsYmFyUG9zaXRpb24sXHJcbiAgU2Nyb2xsYmFyT3JpZW50YXRpb24sXHJcbiAgU2Nyb2xsYmFyVXBkYXRlUmVhc29uLFxyXG4gIFNjcm9sbGJhclZpc2liaWxpdHksXHJcbiAgVmlld3BvcnRCb3VuZGFyaWVzXHJcbn0gZnJvbSAnLi9uZy1zY3JvbGxiYXIubW9kZWwnO1xyXG5cclxuaW50ZXJmYWNlIFZpZXdwb3J0U3RhdGUge1xyXG4gIHZlcnRpY2FsVXNlZDogYm9vbGVhbixcclxuICBob3Jpem9udGFsVXNlZDogYm9vbGVhbixcclxuICBpc1ZlcnRpY2FsbHlTY3JvbGxhYmxlOiBib29sZWFuLFxyXG4gIGlzSG9yaXpvbnRhbGx5U2Nyb2xsYWJsZTogYm9vbGVhbixcclxufVxyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgaG9zdDoge1xyXG4gICAgJ1tjbGFzcy5uZy1zY3JvbGxiYXJdJzogJ3RydWUnLFxyXG4gICAgJ1thdHRyLnZlcnRpY2FsVXNlZF0nOiAndmVydGljYWxVc2VkKCknLFxyXG4gICAgJ1thdHRyLmhvcml6b250YWxVc2VkXSc6ICdob3Jpem9udGFsVXNlZCgpJyxcclxuICAgICdbYXR0ci5pc1ZlcnRpY2FsbHlTY3JvbGxhYmxlXSc6ICdpc1ZlcnRpY2FsbHlTY3JvbGxhYmxlKCknLFxyXG4gICAgJ1thdHRyLmlzSG9yaXpvbnRhbGx5U2Nyb2xsYWJsZV0nOiAnaXNIb3Jpem9udGFsbHlTY3JvbGxhYmxlKCknLFxyXG4gICAgJ1thdHRyLm1vYmlsZV0nOiAnaXNNb2JpbGUnLFxyXG4gICAgJ1thdHRyLmRpcl0nOiAnZGlyZWN0aW9uKCknLFxyXG4gICAgJ1thdHRyLnBvc2l0aW9uXSc6ICdwb3NpdGlvbicsXHJcbiAgICAnW2F0dHIuZHJhZ2dpbmddJzogJ2RyYWdnaW5nKCknLFxyXG4gICAgJ1thdHRyLmFwcGVhcmFuY2VdJzogJ2FwcGVhcmFuY2UnLFxyXG4gICAgJ1thdHRyLnZpc2liaWxpdHldJzogJ3Zpc2liaWxpdHkoKScsXHJcbiAgICAnW2F0dHIub3JpZW50YXRpb25dJzogJ29yaWVudGF0aW9uKCknLFxyXG4gICAgJ1thdHRyLmRpc2FibGVJbnRlcmFjdGlvbl0nOiAnaW50ZXJhY3Rpb25EaXNhYmxlZCgpJ1xyXG4gIH0sXHJcbiAgcHJvdmlkZXJzOiBbeyBwcm92aWRlOiBOR19TQ1JPTExCQVIsIHVzZUV4aXN0aW5nOiBOZ1Njcm9sbGJhckNvcmUgfV1cclxufSlcclxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIE5nU2Nyb2xsYmFyQ29yZSBpbXBsZW1lbnRzIF9OZ1Njcm9sbGJhciwgT25Jbml0LCBBZnRlclZpZXdJbml0IHtcclxuXHJcbiAgcHJpdmF0ZSByZWFkb25seSBwbGF0Zm9ybTogUGxhdGZvcm0gPSBpbmplY3QoUGxhdGZvcm0pO1xyXG4gIHByaXZhdGUgcmVhZG9ubHkgem9uZTogTmdab25lID0gaW5qZWN0KE5nWm9uZSk7XHJcbiAgcHJpdmF0ZSByZWFkb25seSBpbmplY3RvcjogSW5qZWN0b3IgPSBpbmplY3QoSW5qZWN0b3IpO1xyXG5cclxuICByZWFkb25seSBpc01vYmlsZTogYm9vbGVhbiA9IHRoaXMucGxhdGZvcm0uU0FGQVJJIHx8IHRoaXMucGxhdGZvcm0uQU5EUk9JRDtcclxuXHJcbiAgZGlyOiBEaXJlY3Rpb25hbGl0eSA9IGluamVjdChEaXJlY3Rpb25hbGl0eSk7XHJcblxyXG4gIG1hbmFnZXI6IFNjcm9sbGJhck1hbmFnZXIgPSBpbmplY3QoU2Nyb2xsYmFyTWFuYWdlcik7XHJcblxyXG4gIHNtb290aFNjcm9sbDogU21vb3RoU2Nyb2xsTWFuYWdlciA9IGluamVjdChTbW9vdGhTY3JvbGxNYW5hZ2VyKTtcclxuXHJcbiAgbmF0aXZlRWxlbWVudDogSFRNTEVsZW1lbnQgPSBpbmplY3QoRWxlbWVudFJlZjxIVE1MRWxlbWVudD4pLm5hdGl2ZUVsZW1lbnQ7XHJcblxyXG4gIHJ0bFNjcm9sbEF4aXNUeXBlOiBSdGxTY3JvbGxBeGlzVHlwZSA9IHRoaXMubWFuYWdlci5ydGxTY3JvbGxBeGlzVHlwZTtcclxuXHJcbiAgZGlyZWN0aW9uOiBTaWduYWw8RGlyZWN0aW9uPjtcclxuXHJcbiAgLyoqXHJcbiAgICogSW5kaWNhdGVzIHdoZW4gc2Nyb2xsYmFyIHRodW1iIGlzIGJlaW5nIGRyYWdnZWRcclxuICAgKi9cclxuICBkcmFnZ2luZzogV3JpdGFibGVTaWduYWw8U2Nyb2xsYmFyRHJhZ2dpbmc+ID0gc2lnbmFsKCdub25lJyk7XHJcblxyXG4gIC8qKlxyXG4gICAqIFNldHMgdGhlIHN1cHBvcnRlZCBzY3JvbGwgdHJhY2sgb2YgdGhlIHZpZXdwb3J0LCB0aGVyZSBhcmUgMyBvcHRpb25zOlxyXG4gICAqXHJcbiAgICogLSBgdmVydGljYWxgIFVzZSBib3RoIHZlcnRpY2FsIGFuZCBob3Jpem9udGFsIHNjcm9sbGJhclxyXG4gICAqIC0gYGhvcml6b250YWxgIFVzZSBib3RoIHZlcnRpY2FsIGFuZCBob3Jpem9udGFsIHNjcm9sbGJhclxyXG4gICAqIC0gYGF1dG9gIFVzZSBib3RoIHZlcnRpY2FsIGFuZCBob3Jpem9udGFsIHNjcm9sbGJhclxyXG4gICAqL1xyXG4gIG9yaWVudGF0aW9uOiBJbnB1dFNpZ25hbDxTY3JvbGxiYXJPcmllbnRhdGlvbj4gPSBpbnB1dDxTY3JvbGxiYXJPcmllbnRhdGlvbj4odGhpcy5tYW5hZ2VyLmdsb2JhbE9wdGlvbnMub3JpZW50YXRpb24pO1xyXG5cclxuICAvKipcclxuICAgKiBXaGVuIHRvIHNob3cgdGhlIHNjcm9sbGJhciwgYW5kIHRoZXJlIGFyZSAzIG9wdGlvbnM6XHJcbiAgICpcclxuICAgKiAtIGBuYXRpdmVgIChkZWZhdWx0KSBTY3JvbGxiYXIgd2lsbCBiZSB2aXNpYmxlIHdoZW4gdmlld3BvcnQgaXMgc2Nyb2xsYWJsZSBsaWtlIHdpdGggbmF0aXZlIHNjcm9sbGJhclxyXG4gICAqIC0gYGhvdmVyYCBTY3JvbGxiYXJzIGFyZSBoaWRkZW4gYnkgZGVmYXVsdCwgb25seSB2aXNpYmxlIG9uIHNjcm9sbGluZyBvciBob3ZlcmluZ1xyXG4gICAqIC0gYGFsd2F5c2AgU2Nyb2xsYmFycyBhcmUgYWx3YXlzIHNob3duIGV2ZW4gaWYgdGhlIHZpZXdwb3J0IGlzIG5vdCBzY3JvbGxhYmxlXHJcbiAgICovXHJcbiAgdmlzaWJpbGl0eTogSW5wdXRTaWduYWw8U2Nyb2xsYmFyVmlzaWJpbGl0eT4gPSBpbnB1dDxTY3JvbGxiYXJWaXNpYmlsaXR5Pih0aGlzLm1hbmFnZXIuZ2xvYmFsT3B0aW9ucy52aXNpYmlsaXR5KTtcclxuXHJcbiAgLyoqIERpc2FibGVzIHNjcm9sbGJhciBpbnRlcmFjdGlvbiBsaWtlIGRyYWdnaW5nIHRodW1iIGFuZCBqdW1waW5nIGJ5IHRyYWNrIGNsaWNrICovXHJcbiAgZGlzYWJsZUludGVyYWN0aW9uOiBJbnB1dFNpZ25hbFdpdGhUcmFuc2Zvcm08Ym9vbGVhbiwgc3RyaW5nIHwgYm9vbGVhbj4gPSBpbnB1dDxib29sZWFuLCBzdHJpbmcgfCBib29sZWFuPih0aGlzLm1hbmFnZXIuZ2xvYmFsT3B0aW9ucy5kaXNhYmxlSW50ZXJhY3Rpb24sIHtcclxuICAgIHRyYW5zZm9ybTogYm9vbGVhbkF0dHJpYnV0ZVxyXG4gIH0pO1xyXG5cclxuICAvKiogQSBjb21wdXRlZCBzaWduYWwgZm9yIGRpc2FibGluZyB0aGUgaW50ZXJhY3Rpb24gKi9cclxuICBpbnRlcmFjdGlvbkRpc2FibGVkOiBTaWduYWw8Ym9vbGVhbj4gPSBjb21wdXRlZCgoKSA9PiB7XHJcbiAgICByZXR1cm4gdGhpcy5pc01vYmlsZSB8fCB0aGlzLmRpc2FibGVJbnRlcmFjdGlvbigpO1xyXG4gIH0pO1xyXG5cclxuICAvKiogV2hldGhlciBSZXNpemVPYnNlcnZlciBpcyBkaXNhYmxlZCAqL1xyXG4gIGRpc2FibGVTZW5zb3I6IElucHV0U2lnbmFsV2l0aFRyYW5zZm9ybTxib29sZWFuLCBzdHJpbmcgfCBib29sZWFuPiA9IGlucHV0PGJvb2xlYW4sIHN0cmluZyB8IGJvb2xlYW4+KHRoaXMubWFuYWdlci5nbG9iYWxPcHRpb25zLmRpc2FibGVTZW5zb3IsIHtcclxuICAgIHRyYW5zZm9ybTogYm9vbGVhbkF0dHJpYnV0ZVxyXG4gIH0pO1xyXG5cclxuICAvKiogVGhyb3R0bGUgaW50ZXJ2YWwgZm9yIGRldGVjdGluZyBjaGFuZ2VzIHZpYSBSZXNpemVPYnNlcnZlciAqL1xyXG4gIHNlbnNvclRocm90dGxlVGltZTogSW5wdXRTaWduYWw8bnVtYmVyPiA9IGlucHV0PG51bWJlciwgbnVtYmVyPih0aGlzLm1hbmFnZXIuZ2xvYmFsT3B0aW9ucy5zZW5zb3JUaHJvdHRsZVRpbWUsIHtcclxuICAgIHRyYW5zZm9ybTogbnVtYmVyQXR0cmlidXRlXHJcbiAgfSk7XHJcblxyXG4gIHZpZXdwb3J0RGltZW5zaW9uOiBXcml0YWJsZVNpZ25hbDxWaWV3cG9ydEJvdW5kYXJpZXM+ID0gc2lnbmFsKHtcclxuICAgIGNvbnRlbnRIZWlnaHQ6IDAsXHJcbiAgICBjb250ZW50V2lkdGg6IDAsXHJcbiAgICBvZmZzZXRIZWlnaHQ6IDAsXHJcbiAgICBvZmZzZXRXaWR0aDogMFxyXG4gIH0pO1xyXG5cclxuICBzdGF0ZTogU2lnbmFsPFZpZXdwb3J0U3RhdGU+ID0gY29tcHV0ZWQoKCkgPT4ge1xyXG4gICAgbGV0IHZlcnRpY2FsVXNlZDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgbGV0IGhvcml6b250YWxVc2VkOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICBsZXQgaXNWZXJ0aWNhbGx5U2Nyb2xsYWJsZTogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgbGV0IGlzSG9yaXpvbnRhbGx5U2Nyb2xsYWJsZTogYm9vbGVhbiA9IGZhbHNlO1xyXG5cclxuICAgIGNvbnN0IG9yaWVudGF0aW9uOiBTY3JvbGxiYXJPcmllbnRhdGlvbiA9IHRoaXMub3JpZW50YXRpb24oKTtcclxuICAgIGNvbnN0IHZpc2liaWxpdHk6IFNjcm9sbGJhclZpc2liaWxpdHkgPSB0aGlzLnZpc2liaWxpdHkoKTtcclxuICAgIGNvbnN0IHZpZXdwb3J0OiBWaWV3cG9ydEJvdW5kYXJpZXMgPSB0aGlzLnZpZXdwb3J0RGltZW5zaW9uKCk7XHJcblxyXG4gICAgLy8gQ2hlY2sgaWYgdmVydGljYWwgc2Nyb2xsYmFyIHNob3VsZCBiZSBkaXNwbGF5ZWRcclxuICAgIGlmIChvcmllbnRhdGlvbiA9PT0gJ2F1dG8nIHx8IG9yaWVudGF0aW9uID09PSAndmVydGljYWwnKSB7XHJcbiAgICAgIGlzVmVydGljYWxseVNjcm9sbGFibGUgPSB2aWV3cG9ydC5jb250ZW50SGVpZ2h0ID4gdmlld3BvcnQub2Zmc2V0SGVpZ2h0O1xyXG4gICAgICB2ZXJ0aWNhbFVzZWQgPSB2aXNpYmlsaXR5ID09PSAnYWx3YXlzJyB8fCBpc1ZlcnRpY2FsbHlTY3JvbGxhYmxlO1xyXG4gICAgfVxyXG4gICAgLy8gQ2hlY2sgaWYgaG9yaXpvbnRhbCBzY3JvbGxiYXIgc2hvdWxkIGJlIGRpc3BsYXllZFxyXG4gICAgaWYgKG9yaWVudGF0aW9uID09PSAnYXV0bycgfHwgb3JpZW50YXRpb24gPT09ICdob3Jpem9udGFsJykge1xyXG4gICAgICBpc0hvcml6b250YWxseVNjcm9sbGFibGUgPSB2aWV3cG9ydC5jb250ZW50V2lkdGggPiB2aWV3cG9ydC5vZmZzZXRXaWR0aDtcclxuICAgICAgaG9yaXpvbnRhbFVzZWQgPSB2aXNpYmlsaXR5ID09PSAnYWx3YXlzJyB8fCBpc0hvcml6b250YWxseVNjcm9sbGFibGU7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgdmVydGljYWxVc2VkLFxyXG4gICAgICBob3Jpem9udGFsVXNlZCxcclxuICAgICAgaXNWZXJ0aWNhbGx5U2Nyb2xsYWJsZSxcclxuICAgICAgaXNIb3Jpem9udGFsbHlTY3JvbGxhYmxlLFxyXG4gICAgfTtcclxuICB9KTtcclxuXHJcbiAgaXNWZXJ0aWNhbGx5U2Nyb2xsYWJsZTogU2lnbmFsPGJvb2xlYW4+ID0gY29tcHV0ZWQoKCkgPT4gdGhpcy5zdGF0ZSgpLmlzVmVydGljYWxseVNjcm9sbGFibGUpO1xyXG4gIGlzSG9yaXpvbnRhbGx5U2Nyb2xsYWJsZTogU2lnbmFsPGJvb2xlYW4+ID0gY29tcHV0ZWQoKCkgPT4gdGhpcy5zdGF0ZSgpLmlzSG9yaXpvbnRhbGx5U2Nyb2xsYWJsZSk7XHJcbiAgdmVydGljYWxVc2VkOiBTaWduYWw8Ym9vbGVhbj4gPSBjb21wdXRlZCgoKSA9PiB0aGlzLnN0YXRlKCkudmVydGljYWxVc2VkKTtcclxuICBob3Jpem9udGFsVXNlZDogU2lnbmFsPGJvb2xlYW4+ID0gY29tcHV0ZWQoKCkgPT4gdGhpcy5zdGF0ZSgpLmhvcml6b250YWxVc2VkKTtcclxuXHJcbiAgLyoqIFNjcm9sbCBkdXJhdGlvbiB3aGVuIHRoZSBzY3JvbGwgdHJhY2sgaXMgY2xpY2tlZCAqL1xyXG4gIEBJbnB1dCh7XHJcbiAgICBhbGlhczogJ2NsaWNrU2Nyb2xsRHVyYXRpb24nLFxyXG4gICAgdHJhbnNmb3JtOiBudW1iZXJBdHRyaWJ1dGVcclxuICB9KSB0cmFja0NsaWNrRHVyYXRpb246IG51bWJlciA9IHRoaXMubWFuYWdlci5nbG9iYWxPcHRpb25zLmNsaWNrU2Nyb2xsRHVyYXRpb247XHJcblxyXG4gIC8qKlxyXG4gICAqICBTZXRzIHRoZSBhcHBlYXJhbmNlIG9mIHRoZSBzY3JvbGxiYXIsIHRoZXJlIGFyZSAyIG9wdGlvbnM6XHJcbiAgICpcclxuICAgKiAtIGBzdGFuZGFyZGAgKGRlZmF1bHQpIHNjcm9sbGJhciBzcGFjZSB3aWxsIGJlIHJlc2VydmVkIGp1c3QgbGlrZSB3aXRoIG5hdGl2ZSBzY3JvbGxiYXIuXHJcbiAgICogLSBgY29tcGFjdGAgc2Nyb2xsYmFyIGRvZXNuJ3QgcmVzZXJ2ZSBhbnkgc3BhY2UsIHRoZXkgYXJlIHBsYWNlZCBvdmVyIHRoZSB2aWV3cG9ydC5cclxuICAgKi9cclxuICBASW5wdXQoKSBhcHBlYXJhbmNlOiBTY3JvbGxiYXJBcHBlYXJhbmNlID0gdGhpcy5tYW5hZ2VyLmdsb2JhbE9wdGlvbnMuYXBwZWFyYW5jZTtcclxuICAvKipcclxuICAgKiBTZXRzIHRoZSBwb3NpdGlvbiBvZiBlYWNoIHNjcm9sbGJhciwgdGhlcmUgYXJlIDQgb3B0aW9uczpcclxuICAgKlxyXG4gICAqIC0gYG5hdGl2ZWAgKERlZmF1bHQpIFVzZSB0aGUgZGVmYXVsdCBwb3NpdGlvbiBsaWtlIGluIG5hdGl2ZSBzY3JvbGxiYXIuXHJcbiAgICogLSBgaW52ZXJ0WWAgSW52ZXJ0cyB2ZXJ0aWNhbCBzY3JvbGxiYXIgcG9zaXRpb25cclxuICAgKiAtIGBpbnZlcnRYYCBJbnZlcnRzIEhvcml6b250YWwgc2Nyb2xsYmFyIHBvc2l0aW9uXHJcbiAgICogLSBgaW52ZXJ0QWxsYCBJbnZlcnRzIGJvdGggc2Nyb2xsYmFyIHBvc2l0aW9uc1xyXG4gICAqL1xyXG4gIEBJbnB1dCgpIHBvc2l0aW9uOiBTY3JvbGxiYXJQb3NpdGlvbiA9IHRoaXMubWFuYWdlci5nbG9iYWxPcHRpb25zLnBvc2l0aW9uO1xyXG5cclxuICAvKiogQSBjbGFzcyBmb3J3YXJkZWQgdG8gdGhlIHNjcm9sbGJhciB0cmFjayBlbGVtZW50ICovXHJcbiAgQElucHV0KCkgdHJhY2tDbGFzczogc3RyaW5nID0gdGhpcy5tYW5hZ2VyLmdsb2JhbE9wdGlvbnMudHJhY2tDbGFzcztcclxuICAvKiogQSBjbGFzcyBmb3J3YXJkZWQgdG8gdGhlIHNjcm9sbGJhciB0aHVtYiBlbGVtZW50ICovXHJcbiAgQElucHV0KCkgdGh1bWJDbGFzczogc3RyaW5nID0gdGhpcy5tYW5hZ2VyLmdsb2JhbE9wdGlvbnMudGh1bWJDbGFzcztcclxuXHJcbiAgLyoqIFN0ZWFtIHRoYXQgZW1pdHMgd2hlbiBzY3JvbGxiYXIgaXMgaW5pdGlhbGl6ZWQgKi9cclxuICBAT3V0cHV0KCkgYWZ0ZXJJbml0OiBFdmVudEVtaXR0ZXI8dm9pZD4gPSBuZXcgRXZlbnRFbWl0dGVyPHZvaWQ+KCk7XHJcblxyXG4gIC8qKiBTdGVhbSB0aGF0IGVtaXRzIHdoZW4gc2Nyb2xsYmFyIGlzIHVwZGF0ZWQgKi9cclxuICBAT3V0cHV0KCkgYWZ0ZXJVcGRhdGU6IEV2ZW50RW1pdHRlcjx2b2lkPiA9IG5ldyBFdmVudEVtaXR0ZXI8dm9pZD4oKTtcclxuXHJcbiAgLyoqIFJlc2l6ZSBvYnNlcnZlciBzdWJzY3JpcHRpb24gKi9cclxuICBwcml2YXRlIHNpemVDaGFuZ2VTdWI6IFN1YnNjcmlwdGlvbjtcclxuXHJcbiAgYWJzdHJhY3Qgdmlld3BvcnQ6IFZpZXdwb3J0QWRhcHRlcjtcclxuXHJcbiAgYWJzdHJhY3Qgc2Nyb2xsYmFyczogU2Nyb2xsYmFycztcclxuXHJcbiAgbmdPbkluaXQoKTogdm9pZCB7XHJcbiAgICBydW5JbkluamVjdGlvbkNvbnRleHQodGhpcy5pbmplY3RvciwgKCkgPT4ge1xyXG4gICAgICAvLyBUaGUgZGlyZWN0aW9uIHNpZ25hbCBjYW5ub3QgYmUgaW5pdGlhbGl6ZWQgaW4gdGhlIGNvbnN0cnVjdG9yXHJcbiAgICAgIC8vIEJlY2F1c2UgaXQgaW5pdGlhbGx5IHJldHVybnMgJ2x0cicgZXZlbiBpZiBkaXIudmFsdWUgaXMgJ3J0bGBcclxuICAgICAgdGhpcy5kaXJlY3Rpb24gPSB0b1NpZ25hbDxEaXJlY3Rpb24sIERpcmVjdGlvbj4odGhpcy5kaXIuY2hhbmdlLnBpcGUobWFwKCgpID0+IHRoaXMuZGlyLnZhbHVlKSksIHsgaW5pdGlhbFZhbHVlOiB0aGlzLmRpci52YWx1ZSB9KTtcclxuXHJcbiAgICAgIGVmZmVjdCgob25DbGVhbnVwOiBFZmZlY3RDbGVhbnVwUmVnaXN0ZXJGbikgPT4ge1xyXG4gICAgICAgIC8vIENoZWNrIHdoZXRoZXIgc2Vuc29yIHNob3VsZCBiZSBlbmFibGVkXHJcbiAgICAgICAgaWYgKHRoaXMuZGlzYWJsZVNlbnNvcigpKSB7XHJcbiAgICAgICAgICAvLyBJZiBzZW5zb3IgaXMgZGlzYWJsZWQgdXBkYXRlIG1hbnVhbGx5XHJcbiAgICAgICAgICB0aGlzLnNpemVDaGFuZ2VTdWI/LnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIGlmICh0aGlzLnBsYXRmb3JtLmlzQnJvd3Nlcikge1xyXG4gICAgICAgICAgICB0aGlzLnNpemVDaGFuZ2VTdWI/LnVuc3Vic2NyaWJlKCk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnNpemVDaGFuZ2VTdWIgPSByZXNpemVTZW5zb3IodGhpcy52aWV3cG9ydC5uYXRpdmVFbGVtZW50LCB0aGlzLnNlbnNvclRocm90dGxlVGltZSgpKS5waXBlKFxyXG4gICAgICAgICAgICAgIHRhcCgocmVhc29uOiBTY3JvbGxiYXJVcGRhdGVSZWFzb24pID0+IHRoaXMudXBkYXRlKHJlYXNvbikpXHJcbiAgICAgICAgICAgICkuc3Vic2NyaWJlKCk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBvbkNsZWFudXAoKCkgPT4gdGhpcy5zaXplQ2hhbmdlU3ViPy51bnN1YnNjcmliZSgpKTtcclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpOiB2b2lkIHtcclxuICAgIC8vIElmIHNlbnNvciBpcyBkaXNhYmxlZCwgdXBkYXRlIHRvIGV2YWx1YXRlIHRoZSBzdGF0ZVxyXG4gICAgaWYgKHRoaXMucGxhdGZvcm0uaXNCcm93c2VyICYmIHRoaXMuZGlzYWJsZVNlbnNvcigpKSB7XHJcbiAgICAgIC8vIEluIGNhc2Ugb2YgM3JkIHBhcnR5IGxpYnJhcnksIG5lZWQgdG8gd2FpdCBmb3IgY29udGVudCB0byBiZSByZW5kZXJlZFxyXG4gICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMudXBkYXRlKFNjcm9sbGJhclVwZGF0ZVJlYXNvbi5BZnRlckluaXQpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFVwZGF0ZSBsb2NhbCBzdGF0ZSBhbmQgdGhlIGludGVybmFsIHNjcm9sbGJhciBjb250cm9sc1xyXG4gICAqL1xyXG4gIHVwZGF0ZShyZWFzb24/OiBTY3JvbGxiYXJVcGRhdGVSZWFzb24pOiB2b2lkIHtcclxuICAgIHRoaXMudXBkYXRlQ1NTVmFyaWFibGVzKCk7XHJcblxyXG4gICAgdGhpcy56b25lLnJ1bigoKSA9PiB7XHJcbiAgICAgIHRoaXMudmlld3BvcnREaW1lbnNpb24uc2V0KHtcclxuICAgICAgICBjb250ZW50SGVpZ2h0OiB0aGlzLnZpZXdwb3J0LmNvbnRlbnRIZWlnaHQsXHJcbiAgICAgICAgY29udGVudFdpZHRoOiB0aGlzLnZpZXdwb3J0LmNvbnRlbnRXaWR0aCxcclxuICAgICAgICBvZmZzZXRIZWlnaHQ6IHRoaXMudmlld3BvcnQub2Zmc2V0SGVpZ2h0LFxyXG4gICAgICAgIG9mZnNldFdpZHRoOiB0aGlzLnZpZXdwb3J0Lm9mZnNldFdpZHRoXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgaWYgKHJlYXNvbiA9PT0gU2Nyb2xsYmFyVXBkYXRlUmVhc29uLkFmdGVySW5pdCkge1xyXG4gICAgICAgIHRoaXMuYWZ0ZXJJbml0LmVtaXQoKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0aGlzLmFmdGVyVXBkYXRlLmVtaXQoKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTbW9vdGggc2Nyb2xsIGZ1bmN0aW9uc1xyXG4gICAqL1xyXG4gIHNjcm9sbFRvKG9wdGlvbnM6IFNtb290aFNjcm9sbFRvT3B0aW9ucyk6IFByb21pc2U8dm9pZD4ge1xyXG4gICAgcmV0dXJuIHRoaXMuc21vb3RoU2Nyb2xsLnNjcm9sbFRvKHRoaXMudmlld3BvcnQhLm5hdGl2ZUVsZW1lbnQsIHtcclxuICAgICAgZHVyYXRpb246IHRoaXMudHJhY2tDbGlja0R1cmF0aW9uLFxyXG4gICAgICAuLi5vcHRpb25zXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNjcm9sbCB0byBlbGVtZW50IGJ5IHJlZmVyZW5jZSBvciBzZWxlY3RvclxyXG4gICAqL1xyXG4gIHNjcm9sbFRvRWxlbWVudCh0YXJnZXQ6IFNtb290aFNjcm9sbEVsZW1lbnQsIG9wdGlvbnM/OiBTbW9vdGhTY3JvbGxUb0VsZW1lbnRPcHRpb25zKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICByZXR1cm4gdGhpcy5zbW9vdGhTY3JvbGwuc2Nyb2xsVG9FbGVtZW50KHRoaXMudmlld3BvcnQubmF0aXZlRWxlbWVudCwgdGFyZ2V0LCBvcHRpb25zKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFVwZGF0ZSBFc3NlbnRpYWwgQ1NTIHZhcmlhYmxlc1xyXG4gICAqL1xyXG4gIHByaXZhdGUgdXBkYXRlQ1NTVmFyaWFibGVzKCk6IHZvaWQge1xyXG4gICAgdGhpcy5uYXRpdmVFbGVtZW50LnN0eWxlLnNldFByb3BlcnR5KCctLWNvbnRlbnQtaGVpZ2h0JywgYCR7IHRoaXMudmlld3BvcnQuY29udGVudEhlaWdodCB9YCk7XHJcbiAgICB0aGlzLm5hdGl2ZUVsZW1lbnQuc3R5bGUuc2V0UHJvcGVydHkoJy0tY29udGVudC13aWR0aCcsIGAkeyB0aGlzLnZpZXdwb3J0LmNvbnRlbnRXaWR0aCB9YCk7XHJcbiAgICB0aGlzLm5hdGl2ZUVsZW1lbnQuc3R5bGUuc2V0UHJvcGVydHkoJy0tdmlld3BvcnQtaGVpZ2h0JywgYCR7IHRoaXMudmlld3BvcnQub2Zmc2V0SGVpZ2h0IH1gKTtcclxuICAgIHRoaXMubmF0aXZlRWxlbWVudC5zdHlsZS5zZXRQcm9wZXJ0eSgnLS12aWV3cG9ydC13aWR0aCcsIGAkeyB0aGlzLnZpZXdwb3J0Lm9mZnNldFdpZHRoIH1gKTtcclxuICB9XHJcbn1cclxuIl19